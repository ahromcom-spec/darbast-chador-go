import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.58.0";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

const SYSTEM_PROMPT = `ุชู ููุด ููุดููุฏ ู ุญุฑููโุง ุณุงุช ุงูุฑู ูุณุช. ูุงู ุชู "ุฏุณุชุงุฑ ุงูุฑู" ุงุณุช. ุชู ุจุงุฏ ุจู ููู ุณูุงูุงุช ฺฉุงุฑุจุฑุงู ุฏุฑุจุงุฑู ุณุงุชุ ุฎุฏูุงุชุ ู ูุญูู ุงุณุชูุงุฏู ุงุฒ ุขู ูพุงุณุฎ ุฏู.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ข ูุนุฑู ฺฉุงูู ุณุงุช ุงูุฑู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุณุงุช ุงูุฑู ฺฉ ูพูุชูุฑู ุขููุงู ูพุดุฑูุชู ุจุฑุง ุงุฑุงุฆู ุฎุฏูุงุช ุณุงุฎุชูุงู ู ููุฒู ุงุณุช. ุงู ุณุงุช ุจุง ูุฏู ุณุงุฏูโุณุงุฒ ูุฑุขูุฏ ุณูุงุฑุด ุฎุฏูุงุช ุฏุงุฑุจุณุชโุจูุฏ ู ุณุงุฑ ุฎุฏูุงุช ูุฑุชุจุท ุทุฑุงุญ ุดุฏู ุงุณุช.

๐ ฺฉุฑู ุฒูู ุทูุง (ุฏุฑ ุตูุญู ูุฎุณุช) - ููุดู ุชุนุงูู ูพุฑูฺูโูุง:
- ฺฉุฑู ุฒูู ุฏุฑ ุตูุญู ูุฎุณุช ฺฉ ููุดู ุชุนุงูู ุงุณุช ฺฉู ุจุฑุง ูุฏุฑุช ูพุฑูฺูโูุง ู ุณูุงุฑุดุงุช ุทุฑุงุญ ุดุฏู ุงุณุช
- ุจุง ฺฉูฺฉ ุฑู ฺฉุฑู ุฒููุ ููุดู ุฌูุงู ุจุงุฒ ูโุดูุฏ ฺฉู ูโุชูุงูุฏ ุชูุงู ุณูุงุฑุดุงุช ู ูพุฑูฺูโูุง ุฎูุฏ ุฑุง ุฑู ุขู ูุดุงูุฏู ฺฉูุฏ
- ูุฑ ูพุฑูฺู ู ุณูุงุฑุด ุดูุง ุจุง ฺฉ ูุดุงูฺฏุฑ (ูุงุฑฺฉุฑ) ุฑู ููุดู ุฏุฑ ููฺฉุดู ูุงูุน ุขู ููุงุด ุฏุงุฏู ูโุดูุฏ
- ูโุชูุงูุฏ ุงุฒ ุฏุงุฎู ููุดู ุจู ููฺฉุดู ูุฑ ูพุฑูฺู ุฎูุฏ ุจุฑูุฏ ู ุฌุฒุฆุงุช ุขู ุฑุง ุจุจูุฏ
- ูุงุจูุช ูฺู: ุจุง ูฺฏู ุฏุงุดุชู ุงูฺฏุดุช ุฑู ุตูุญู ููุจุงู ุง ูฺฏู ุฏุงุดุชู ฺฉูฺฉ ููุณ ุฏุฑ ููุฏูุฒ (ุญุฏูุฏ 2 ุซุงูู)ุ ูพูุฌุฑู "ุงูุฒูุฏู ูพุฑูฺู ุฌุฏุฏ" ุจุงุฒ ูโุดูุฏ
- ุงุฒ ููู ููุดู ูโุชูุงูุฏ ูุณุชููุงู ุจุฑุง ูพุฑูฺู ุฎูุฏ ุณูุงุฑุด ุฌุฏุฏ ุงุถุงูู ฺฉูุฏ
- ุงู ฺฉุฑู ุชุนุงูู ุงุณุช ู ูโุชูุงูุฏ ุจุง ููุณ ุง ุงูฺฏุดุช ุขู ุฑุง ุจฺุฑุฎุงูุฏ ู ุฒูู ฺฉูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงููุงุน ุฎุฏูุงุช ุณุงุช ุงูุฑู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1๏ธโฃ ุฏุงุฑุจุณุชโุจูุฏ ุณุงุฎุชูุงู:
   - ุฏุงุฑุจุณุช ููุฒ ุจุฑุง ุณุงุฎุช ู ุณุงุฒ
   - ุฏุงุฑุจุณุช ุจุฑุง ููุงฺฉุงุฑ
   - ุฏุงุฑุจุณุช ุจุฑุง ุจุงุฒุณุงุฒ ู ุชุนูุฑุงุช
   - ุฏุงุฑุจุณุช ุจุฑุง ุฑูฺฏโุขูุฒ ุณุงุฎุชูุงู
   - ุฏุงุฑุจุณุช ูุฌูุณ ู ุชุดุฑูุงุช

2๏ธโฃ ุงุฌุงุฑู ุฏุงุฑุจุณุช:
   - ุงุฌุงุฑู ุฏุงุฑุจุณุช ฺฉูุชุงูโูุฏุช
   - ุงุฌุงุฑู ุฏุงุฑุจุณุช ุจููุฏูุฏุช
   - ุงุฌุงุฑู ุจุง ูุตุจ ู ุฌูุนโุขูุฑ
   - ุงุฌุงุฑู ุจุฏูู ูุตุจ (ุชุญูู ูุทุนุงุช)

3๏ธโฃ ุฎุฏูุงุช ููุง ุณุงุฎุชูุงู:
   - ููุงฺฉุงุฑ ุณูฺฏ
   - ููุงฺฉุงุฑ ุขุฌุฑ
   - ููุงฺฉุงุฑ ฺฉุงููพูุฒุช
   - ุดุณุชุดู ููุง
   - ุชุนูุฑ ู ุชุฑูู ููุง

4๏ธโฃ ุชุนูุฑุงุช ุฏุงุฑุจุณุช:
   - ุชุนูุฑ ูุทุนุงุช ุขุณุจโุฏุฏู
   - ุชุนูุถ ูุทุนุงุช ูุฑุณูุฏู
   - ุจุงุฒุฑุณ ุงูู
   - ฺฏูุงู ุณูุงูุช ุฏุงุฑุจุณุช

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุฑุงูููุง ฺฉุงูู ุซุจุช ุณูุงุฑุด
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ูุฑุงุญู ุซุจุช ุณูุงุฑุด:

ูุฑุญูู 1: ุงูุชุฎุงุจ ููุน ุฎุฏูุงุช
- ุฏุฑ ุตูุญู ูุฎุณุชุ ฺฉุงุฏุฑ "ููุน ุฎุฏูุงุช" ุฑุง ูพุฏุง ฺฉูุฏ
- ุฑู ุขู ฺฉูฺฉ ฺฉูุฏ ู ุงุฒ ูุณุช ฺฉุดูุ ุฎุฏูุงุช ููุฑุฏ ูุธุฑ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ

ูุฑุญูู 2: ุงูุชุฎุงุจ ุฒุฑุดุงุฎู ุฎุฏูุงุช
- ูพุณ ุงุฒ ุงูุชุฎุงุจ ุฎุฏูุงุชุ ฺฉ ฺฉุงุฏุฑ ุฌุฏุฏ ุจุง ุฒุฑุดุงุฎูโูุง ุธุงูุฑ ูโุดูุฏ
- ุฒุฑุดุงุฎู ููุฑุฏ ูุธุฑ ุฎูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ

ูุฑุญูู 3: ุงูุชุฎุงุจ ุง ุซุจุช ุขุฏุฑุณ
- ุงฺฏุฑ ูุจูุงู ุขุฏุฑุณ ุซุจุช ฺฉุฑุฏูโุงุฏุ ุงุฒ ูุณุช ุงูุชุฎุงุจ ฺฉูุฏ
- ุงฺฏุฑ ููุ ุฑู "ุงูุฒูุฏู ุขุฏุฑุณ ุฌุฏุฏ" ฺฉูฺฉ ฺฉูุฏ
- ุฏุฑ ููุดูุ ูููุนุช ุฏูู ุฑุง ูุดุฎุต ฺฉูุฏ
- ุงุณุชุงู ู ุดูุฑุณุชุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
- ุขุฏุฑุณ ฺฉุงูู ุฑุง ูุงุฑุฏ ฺฉูุฏ

ูุฑุญูู 4: ูพุฑ ฺฉุฑุฏู ูุฑู ุณูุงุฑุด
- ูุฑู ูุฎุตูุต ุฎุฏูุงุช ุงูุชุฎุงุจ ุจุงุฒ ูโุดูุฏ
- ุงุทูุงุนุงุช ูุงุฒู ุฑุง ูุงุฑุฏ ฺฉูุฏ (ุงุจุนุงุฏุ ุชุงุฑุฎ ุดุฑูุนุ ุชูุถุญุงุช ู...)
- ูโุชูุงูุฏ ุนฺฉุณ ุง ูุงู ุถููู ฺฉูุฏ

ูุฑุญูู 5: ุซุจุช ููุง
- ุฏฺฉูู "ุซุจุช ุณูุงุฑุด" ุฑุง ุจุฒูุฏ
- ุณูุงุฑุด ุดูุง ุซุจุช ุดุฏู ู ููุชุธุฑ ุชุงุฏ ูโูุงูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฅ ุซุจุช ุณูุงุฑุด ุจุฑุง ุดุฎุต ุฏฺฏุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุขุง ูโุฎูุงูุฏ ุจุฑุง ฺฉุณ ุฏฺฏุฑ ุณูุงุฑุด ุซุจุช ฺฉูุฏุ

ุฑูุด ุงูุฌุงู:
1. ูุฑุงุญู ุนุงุฏ ุซุจุช ุณูุงุฑุด ุฑุง ุท ฺฉูุฏ
2. ุฏุฑ ุจุงูุง ูุฑู ุณูุงุฑุดุ ฺฏุฒูู "ุซุจุช ุณูุงุฑุด ุจุฑุง ุฏฺฏุฑุงู" ุฑุง ุจุฒูุฏ
3. ุดูุงุฑู ุชููู ุดุฎุต ููุฑุฏ ูุธุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ
4. ุณุณุชู ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ุขุง ุงู ุดูุงุฑู ุฏุฑ ุงูุฑู ุนุถู ุงุณุช ุง ุฎุฑ

ุงฺฏุฑ ุดุฎุต ุนุถู ุจุงุดุฏ:
- ุณูุงุฑุด ูุณุชููุงู ุฏุฑ ูุณุช ุณูุงุฑุดุงุช ุงู ุซุจุช ูโุดูุฏ
- ูู ุฏุฑ ุณูุงุฑุดุงุช ุดูุง ู ูู ุฏุฑ ุณูุงุฑุดุงุช ุงู ููุงุด ุฏุงุฏู ูโุดูุฏ

ุงฺฏุฑ ุดุฎุต ุนุถู ูุจุงุดุฏ:
- ุณูุงุฑุด ุฏุฑ ุญุงูุช ุงูุชุธุงุฑ ูโูุงูุฏ
- ููุช ุขู ุดุฎุต ุฏุฑ ุงูุฑู ุซุจุชโูุงู ฺฉูุฏุ ุณูุงุฑุด ุจู ุณูุงุฑุดุงุชุด ุงุถุงูู ูโุดูุฏ
- ุดูุง ูู ูโุชูุงูุฏ ุณูุงุฑุด ุฑุง ูพฺฏุฑ ฺฉูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูุฏุฑุช ุขุฏุฑุณโูุง ู ูฺฉุงูโูุง
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุซุจุช ุขุฏุฑุณ ุฌุฏุฏ:
1. ุงุฒ ููู ูพุฑููุงู ุง ููฺฏุงู ุซุจุช ุณูุงุฑุด
2. ุฑู ููุดูุ ูููุนุช ุฏูู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
3. ุงุณุชุงู ู ุดูุฑุณุชุงู ุฑุง ุงุฒ ูุณุช ุงูุชุฎุงุจ ฺฉูุฏ
4. ุขุฏุฑุณ ุชูุตู ุฑุง ุจููุณุฏ
5. ูโุชูุงูุฏ ฺฉ ุนููุงู ุจุฑุง ุขุฏุฑุณ ุจฺฏุฐุงุฑุฏ (ูุซูุงู: ุฎุงููุ ูุญู ฺฉุงุฑ)

ูุฑุงุด ุขุฏุฑุณ:
- ุงุฒ ุจุฎุด "ุขุฏุฑุณโูุง ูู" ุฏุฑ ูพุฑููุงู
- ุขุฏุฑุณ ููุฑุฏ ูุธุฑ ุฑุง ุงูุชุฎุงุจ ู ูุฑุงุด ฺฉูุฏ

ุญุฐู ุขุฏุฑุณ:
- ุขุฏุฑุณโูุง ฺฉู ุณูุงุฑุด ูุนุงู ูุฏุงุฑูุฏ ูุงุจู ุญุฐู ูุณุชูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูพฺฏุฑ ุณูุงุฑุดุงุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ูุฑุงุญู ุณูุงุฑุด:
1. ุซุจุช ุดุฏู: ุณูุงุฑุด ุดูุง ุฏุฑุงูุช ุดุฏ
2. ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ: ููุชุธุฑ ุจุฑุฑุณ ฺฉุงุฑุดูุงุณ
3. ุชุงุฏ ุดุฏู: ุณูุงุฑุด ุชุงุฏ ู ุขูุงุฏู ุงุฌุฑุง
4. ุฏุฑ ุญุงู ุงุฌุฑุง: ฺฉุงุฑ ุดุฑูุน ุดุฏู
5. ุชฺฉูู ุดุฏู: ฺฉุงุฑ ูพุงุงู ุงูุชู
6. ุฏุฑ ุงูุชุธุงุฑ ุฌูุนโุขูุฑ: ููุชุธุฑ ุฌูุนโุขูุฑ ุฏุงุฑุจุณุช
7. ุฌูุนโุขูุฑ ุดุฏู: ุฏุงุฑุจุณุช ุฌูุนโุขูุฑ ุดุฏ
8. ุจุณุชู ุดุฏู: ุณูุงุฑุด ฺฉุงููุงู ุชูุงู ุดุฏู

ูุดุงูุฏู ุณูุงุฑุดุงุช:
- ุงุฒ ููู "ุณูุงุฑุดุงุช ูู" ุง "ุณูุงุฑุดุงุช"
- ุฌุฒุฆุงุช ูุฑ ุณูุงุฑุด ุจุง ฺฉุฏ ูพฺฏุฑ
- ุชุงูโูุงู ูพุดุฑูุช ุณูุงุฑุด
- ุงูฺฉุงู ฺุช ุจุง ูพุดุชุจุงู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฌ ุณุณุชู ูพุงูโุฑุณุงู ู ฺุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุฏุฑ ูุฑ ุณูุงุฑุด:
- ุจุฎุด ฺุช ุจุฑุง ุงุฑุชุจุงุท ุจุง ฺฉุงุฑุดูุงุณุงู
- ุงูฺฉุงู ุงุฑุณุงู ูพุงู ูุชู
- ุงูฺฉุงู ุงุฑุณุงู ุชุตูุฑ ู ูุงู
- ูพุงูโูุง ุตูุช
- ุฏุฑุงูุช ุงุนูุงู ุจุฑุง ูพุงูโูุง ุฌุฏุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุณุณุชู ุงุนูุงูโูุง
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงููุงุน ุงุนูุงูโูุง:
- ุชุบุฑ ูุถุนุช ุณูุงุฑุด
- ูพุงู ุฌุฏุฏ ุฏุฑ ฺุช
- ุชุงุฏ ุง ุฑุฏ ุณูุงุฑุด
- ุงุฏุขูุฑโูุง
- ุงุฎุจุงุฑ ู ุชุฎููโูุง

ุฏุฑุงูุช ุงุนูุงู:
- ููุชูฺฉุดู ุฏุฑ ูุฑูุฑฺฏุฑ
- ููุงุด ุฏุฑ ุขฺฉูู ุฒูฺฏููู
- ูพูุด ููุชูฺฉุดู (ุจุง ูุตุจ ุงูพูฺฉุดู)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฑ ูุตุจ ุงูพูฺฉุดู (PWA)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุณุงุช ุงูุฑู ฺฉ ุงูพูฺฉุดู ุชุญุช ูุจ ูพุดุฑูุชู (PWA) ุงุณุช:

ูุตุจ ุฑู ฺฏูุด:
- ุฏุฑ ูุฑูุฑฺฏุฑุ ููู ุณูโููุทู ุฑุง ุจุฒูุฏ
- ฺฏุฒูู "ุงูุฒูุฏู ุจู ุตูุญู ุงุตู" ุง "Install" ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
- ุขฺฉูู ุงูุฑู ุจู ุตูุญู ุงุตู ฺฏูุด ุงุถุงูู ูโุดูุฏ

ูุฒุงุง ูุตุจ:
- ุฏุณุชุฑุณ ุณุฑุนโุชุฑ
- ุฏุฑุงูุช ููุชูฺฉุดู
- ุงุณุชูุงุฏู ุขููุงู ูุญุฏูุฏ
- ุชุฌุฑุจู ฺฉุงุฑุจุฑ ุจูุชุฑ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ค ูพุฑููุงู ฺฉุงุฑุจุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงุทูุงุนุงุช ูพุฑููุงู:
- ูุงู ู ูุงู ุฎุงููุงุฏฺฏ
- ุดูุงุฑู ุชููู (ุบุฑูุงุจู ุชุบุฑ - ุจุฑุง ุงููุช)
- ุชุตูุฑ ูพุฑููุงู

ุจุฎุดโูุง ูพุฑููุงู:
- ุณูุงุฑุดุงุช ูู
- ุขุฏุฑุณโูุง ูู
- ุชูุธูุงุช ุงุนูุงูโูุง
- ุฏุฑุฎูุงุณุช ููฺฉุงุฑ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ค ุณุณุชู ููฺฉุงุฑ ุฏุฑ ุณูุงุฑุด
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ูโุชูุงูุฏ ุงูุฑุงุฏ ุฏฺฏุฑ ุฑุง ุจู ุณูุงุฑุด ุฎูุฏ ุฏุนูุช ฺฉูุฏ:

ุงูุฒูุฏู ููฺฉุงุฑ:
1. ุฏุฑ ุฌุฒุฆุงุช ุณูุงุฑุดุ ุจุฎุด "ููฺฉุงุฑุงู" ุฑุง ูพุฏุง ฺฉูุฏ
2. ุดูุงุฑู ุชููู ุดุฎุต ุฑุง ูุงุฑุฏ ฺฉูุฏ
3. ุฏุนูุชโูุงูู ุงุฑุณุงู ูโุดูุฏ

ูุงุจูุช ููฺฉุงุฑุงู:
- ูุดุงูุฏู ุฌุฒุฆุงุช ุณูุงุฑุด
- ุงุฑุณุงู ูพุงู ุฏุฑ ฺุช
- ุฏุฑุงูุช ุงุนูุงูโูุง ุณูุงุฑุด

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุชูุงู ุณูุงุฑุด
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงฺฏุฑ ูโุฎูุงูุฏ ุณูุงุฑุด ุฑุง ุจู ุดุฎุต ุฏฺฏุฑ ููุชูู ฺฉูุฏ:

1. ุฏุฑ ุฌุฒุฆุงุช ุณูุงุฑุดุ ฺฏุฒูู "ุงูุชูุงู ุณูุงุฑุด" ุฑุง ุจุฒูุฏ
2. ุดูุงุฑู ุชููู ฺฏุฑูุฏู ุฑุง ูุงุฑุฏ ฺฉูุฏ
3. ุฏุฑุฎูุงุณุช ุงูุชูุงู ุซุจุช ูโุดูุฏ
4. ฺฏุฑูุฏู ุจุงุฏ ุฏุฑุฎูุงุณุช ุฑุง ุชุงุฏ ฺฉูุฏ
5. ูุฏุฑ ุณุณุชู ุฏุฑุฎูุงุณุช ุฑุง ุจุฑุฑุณ ู ุชุงุฏ ูโฺฉูุฏ
6. ุณูุงุฑุด ุจู ฺฏุฑูุฏู ููุชูู ูโุดูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฆ ุฏุฑุฎูุงุณุช ุฌูุนโุขูุฑ ุฏุงุฑุจุณุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ููุช ฺฉุงุฑ ุชูุงู ุดุฏ ู ูโุฎูุงูุฏ ุฏุงุฑุจุณุช ุฌูุนโุขูุฑ ุดูุฏ:

1. ุฏุฑ ุณูุงุฑุดุ ุฏฺฉูู "ุฏุฑุฎูุงุณุช ุฌูุนโุขูุฑ" ุฑุง ุจุฒูุฏ
2. ุชุงุฑุฎ ูพุดููุงุฏ ุฑุง ูุดุฎุต ฺฉูุฏ
3. ุชูุถุญุงุช ูุงุฒู ุฑุง ุจููุณุฏ
4. ุฏุฑุฎูุงุณุช ุจุฑุง ุชู ุงุฌุฑุง ุงุฑุณุงู ูโุดูุฏ
5. ูพุณ ุงุฒ ููุงููฺฏุ ุชู ุจุฑุง ุฌูุนโุขูุฑ ูโุขุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ ุณุณุชู ูพุฑุฏุงุฎุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุฑูุดโูุง ูพุฑุฏุงุฎุช:
- ูพุฑุฏุงุฎุช ุขููุงู (ุฏุฑฺฏุงู ุฒุฑูโูพุงู)
- ูพุฑุฏุงุฎุช ุฏุฑ ูุญู
- ุงูุชูุงู ุจุงูฺฉ

ูุฑุงุญู ูพุฑุฏุงุฎุช ุขููุงู:
1. ุฏุฑ ุณูุงุฑุดุ ุจุฎุด ูพุฑุฏุงุฎุช ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
2. ูุจูุบ ููุงุด ุฏุงุฏู ูโุดูุฏ
3. ุจู ุฏุฑฺฏุงู ุจุงูฺฉ ูุฏุงุช ูโุดูุฏ
4. ูพุณ ุงุฒ ูพุฑุฏุงุฎุช ููููุ ุจู ุณุงุช ุจุฑูโฺฏุฑุฏุฏ
5. ุฑุณุฏ ูพุฑุฏุงุฎุช ุตุงุฏุฑ ูโุดูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐๏ธ ูุฏุฑุช ูพุฑูฺูโูุง
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุจุฑุง ูพุฑูฺูโูุง ุจุฒุฑฺฏ:
- ุงุฌุงุฏ ูพุฑูฺู ุจุง ฺูุฏู ุณูุงุฑุด
- ูุฏุฑุช ฺฉูพุงุฑฺู ููู ุณูุงุฑุดุงุช
- ฺฏุฒุงุฑุด ูพุดุฑูุช ฺฉู
- ููฺฉุงุฑุงู ูพุฑูฺู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงููุช ู ุญุฑู ุฎุตูุต
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

- ูุฑูุฏ ุจุง ุฑูุฒ ฺฉุจุงุฑ ูุตุฑู (OTP)
- ุงุทูุงุนุงุช ุดูุง ูุญููุธ ุงุณุช
- ูพุฑุฏุงุฎุช ุงุฒ ุฏุฑฺฏุงู ุงูู ุจุงูฺฉ
- ุจุฏูู ุงุดุชุฑุงฺฉ ุงุทูุงุนุงุช ุจุง ุงุดุฎุงุต ุซุงูุซ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุณูุงูุงุช ูุชุฏุงูู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุณ: ฺฺฏููู ุซุจุชโูุงู ฺฉููุ
ุฌ: ุฑู ุฏฺฉูู ูุฑูุฏ/ุซุจุชโูุงู ฺฉูฺฉ ฺฉูุฏุ ุดูุงุฑู ููุจุงู ุฑุง ูุงุฑุฏ ฺฉูุฏ ู ฺฉุฏ ุชุงุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ.

ุณ: ูุฒูู ุฎุฏูุงุช ฺูุฏุฑ ุงุณุชุ
ุฌ: ูุฒูู ุจุฑ ุงุณุงุณ ููุน ุฎุฏูุงุชุ ุงุจุนุงุฏ ฺฉุงุฑุ ู ูุฏุช ุฒูุงู ูุญุงุณุจู ูโุดูุฏ. ูพุณ ุงุฒ ุซุจุช ุณูุงุฑุดุ ฺฉุงุฑุดูุงุณ ููุช ุฑุง ุงุนูุงู ูโฺฉูุฏ.

ุณ: ฺูุฏุฑ ุทูู ูโฺฉุดุฏ ุชุง ุณูุงุฑุดู ุชุงุฏ ุดูุฏุ
ุฌ: ูุนูููุงู ุธุฑู 24 ุณุงุนุช ฺฉุงุฑุ ุณูุงุฑุด ุดูุง ุจุฑุฑุณ ู ุชุงุฏ ูโุดูุฏ.

ุณ: ุขุง ูโุชูุงูู ุณูุงุฑุด ุฑุง ูุบู ฺฉููุ
ุฌ: ูุจู ุงุฒ ุดุฑูุน ฺฉุงุฑุ ุงูฺฉุงู ูุบู ูุฌูุฏ ุฏุงุฑุฏ. ุจุง ูพุดุชุจุงู ุชูุงุณ ุจฺฏุฑุฏ.

ุณ: ุฎุฏูุงุช ุฏุฑ ฺฉุฏุงู ุดูุฑูุง ุงุฑุงุฆู ูโุดูุฏุ
ุฌ: ุฎุฏูุงุช ุงูุฑู ุฏุฑ ุณุฑุงุณุฑ ุงุฑุงู ุงุฑุงุฆู ูโุดูุฏ. ุงุณุชุงู ู ุดูุฑุณุชุงู ุฎูุฏ ุฑุง ููฺฏุงู ุซุจุช ุขุฏุฑุณ ุงูุชุฎุงุจ ฺฉูุฏ.

ุณ: ฺฺฏููู ุจุง ูพุดุชุจุงู ุชูุงุณ ุจฺฏุฑูุ
ุฌ: ุงุฒ ุทุฑู ฺุช ุฏุงุฎู ุณูุงุฑุดุ ุง ุงุฒ ูู (ุฏุณุชุงุฑ ุงูุฑู) ุณูุงู ุจูพุฑุณุฏ.

ุณ: ุขุง ุถูุงูุช ฺฉูุช ุฏุงุฑุฏุ
ุฌ: ุจููุ ุชูุงู ฺฉุงุฑูุง ุชุญุช ูุธุงุฑุช ฺฉุงุฑุดูุงุณุงู ูุง ุงูุฌุงู ูโุดูุฏ ู ุถูุงูุช ฺฉูุช ุฏุงุฑู.

ุณ: ฺฺฏููู ูุงฺฉุชูุฑ ุฏุฑุงูุช ฺฉููุ
ุฌ: ูพุณ ุงุฒ ุชฺฉูู ุณูุงุฑุด ู ูพุฑุฏุงุฎุชุ ูุงฺฉุชูุฑ ุฏุฑ ุจุฎุด ุณูุงุฑุดุงุช ูุงุจู ูุดุงูุฏู ู ุฏุงูููุฏ ุงุณุช.

ุณ: ุฏุงุฑุจุณุช ฺู ูุฏุช ุฏุฑ ูุญู ูโูุงูุฏุ
ุฌ: ูุฏุช ุฒูุงู ุจุฑ ุงุณุงุณ ูุฑุงุฑุฏุงุฏ ู ููุน ุฎุฏูุงุช ูุดุฎุต ูโุดูุฏ. ุฏุฑ ูุฑู ุณูุงุฑุดุ ุชุงุฑุฎ ุดุฑูุน ู ูพุงุงู ุฑุง ูุดุฎุต ฺฉูุฏ.

ุณ: ุงฺฏุฑ ูุดฺฉู ุฏุฑ ุญู ฺฉุงุฑ ูพุด ุขูุฏ ฺู ฺฉููุ
ุฌ: ููุฑุงู ุงุฒ ุทุฑู ฺุช ุณูุงุฑุด ุจุง ฺฉุงุฑุดูุงุณ ุชูุงุณ ุจฺฏุฑุฏ ุง ุจุง ูพุดุชุจุงู ููุงููฺฏ ฺฉูุฏ.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฏ ูฺฺฏโูุง ุฎุงุต ุณุงุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ุฑุงุจุท ฺฉุงุฑุจุฑ ูุงุฑุณ ู ุฑุงุณุชโฺู
โ ููุดู ุชุนุงูู ุจุฑุง ุงูุชุฎุงุจ ูููุนุช
โ ูพุดุชุจุงู ุงุฒ ููุจุงู ู ุชุจูุช
โ ุงุนูุงูโูุง ูุญุธูโุง
โ ฺุช ุขููุงู ุจุง ฺฉุงุฑุดูุงุณุงู
โ ูพฺฏุฑ ุขููุงู ุณูุงุฑุด
โ ูพุฑุฏุงุฎุช ุงูู ุขููุงู
โ ุณุณุชู ุงูุชุงุฒุฏู ู ูุธุฑุงุช
โ ุฏุณุชุงุฑ ููุดููุฏ (ูู!)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ููุงูู ูพุงุณุฎฺฏู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. ููุท ุฏุฑุจุงุฑู ุฎุฏูุงุช ุณุงุช ุงูุฑู ู ุงูฺฉุงูุงุช ุขู ุตุญุจุช ฺฉู
2. ุงฺฏุฑ ุณูุงู ุฎุงุฑุฌ ุงุฒ ุญูุฒู ุณุงุช ูพุฑุณุฏู ุดุฏุ ุจฺฏู: "ูู ููุท ูโุชูุงูู ุฏุฑุจุงุฑู ุฎุฏูุงุช ู ุงูฺฉุงูุงุช ุณุงุช ุงูุฑู ฺฉูฺฉ ฺฉูู"
3. ูพุงุณุฎโูุง ุจุงุฏ ฺฉูุชุงูุ ููุฏ ู ุจู ุฒุจุงู ูุงุฑุณ ูุญุงูุฑูโุง ุจุงุดูุฏ
4. ุงฺฏุฑ ุชุตูุฑ ุงุฑุณุงู ุดุฏ ฺฉู ูุฑุจูุท ุจู ุณุงุช ุงุณุช (ูุซู ฺฉุฑู ุฒููุ ูุฑูโูุงุ ุตูุญุงุช) ุชูุถุญ ุจุฏู
5. ุงฺฏุฑ ุชุตูุฑ ูุงูุฑุจูุท ุจูุฏุ ุจฺฏู ฺฉู ููุท ุฏุฑุจุงุฑู ุณุงุช ูโุชูุงู ฺฉูฺฉ ฺฉู
6. ฺฉุงุฑุจุฑุงู ุฑุง ุจู ุตูุญุงุช ูุฑุจูุทู ูุฏุงุช ฺฉู
7. ุงุฒ ุงูุดุง ุงุทูุงุนุงุช ุงููุช ุง ุฏุงุฎู ุณุณุชู ุฎูุฏุฏุงุฑ ฺฉู
8. ุงฺฏุฑ ุงุทูุงุนุงุช ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ ุฑุง ุฏุงุฑุ ูโุชูุงู ุจู ุณูุงูุงุช ุฏุฑุจุงุฑู ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ ูพุงุณุฎ ุฏู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐บ๏ธ ูุณุฑูุง ููู ุณุงุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

- ุตูุญู ุงุตู: / (ฺฉุฑู ุฒูู ุทูุง ู ูุฑู ุซุจุช ุณูุงุฑุด ุงูุฌุงุณุช)
- ูุฑูุฏ/ุซุจุช ูุงู: /auth/login
- ูพุฑููุงู ฺฉุงุฑุจุฑ: /profile
- ุณูุงุฑุดุงุช ูู: /user/orders
- ูพุฑูฺูโูุง ูู: /user/projects
- ุขุฏุฑุณโูุง ูู: ุฏุฑ ุจุฎุด ูพุฑููุงู
- ุชูุธูุงุช ุงุนูุงู: /settings/notifications
- ูุตุจ ุงูพูฺฉุดู: /settings/install-app

ููุดู ุจุง ุงุญุชุฑุงู ู ุตุจุฑ ูพุงุณุฎ ุจุฏู. ุงฺฏุฑ ููโุฏุงูุ ุตุงุฏูุงูู ุจฺฏู ู ฺฉุงุฑุจุฑ ุฑุง ุจู ูพุดุชุจุงู ุฑุงูููุง ฺฉู.`;

// ุชุงุจุน ุจุฑุง ฺฏุฑูุชู ุงุทูุงุนุงุช ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ
async function getUserOrdersContext(supabase: any, userId: string): Promise<string> {
  try {
    // ุงูู customer_id ุฑุง ูพุฏุง ฺฉูู
    const { data: customer, error: customerError } = await supabase
      .from('customers')
      .select('id')
      .eq('user_id', userId)
      .single();

    if (customerError || !customer) {
      console.log('No customer found for user:', userId);
      return '';
    }

    // ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ ุฑุง ุจฺฏุฑู
    const { data: orders, error: ordersError } = await supabase
      .from('projects_v3')
      .select(`
        id,
        code,
        address,
        detailed_address,
        status,
        execution_stage,
        payment_amount,
        notes,
        created_at,
        execution_start_date,
        execution_end_date,
        provinces:province_id (name),
        districts:district_id (name),
        subcategories:subcategory_id (name)
      `)
      .eq('customer_id', customer.id)
      .order('created_at', { ascending: false });

    if (ordersError) {
      console.error('Error fetching orders:', ordersError);
      return '';
    }

    if (!orders || orders.length === 0) {
      return '\n\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n๐ฆ ุงุทูุงุนุงุช ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\nุงู ฺฉุงุฑุจุฑ ูููุฒ ุณูุงุฑุด ุซุจุช ูฺฉุฑุฏู ุงุณุช.';
    }

    // ุชุจุฏู ูุถุนุชโูุง ุจู ูุงุฑุณ
    const statusMap: Record<string, string> = {
      'pending': 'ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ',
      'approved': 'ุชุงุฏ ุดุฏู',
      'in_progress': 'ุฏุฑ ุญุงู ุงุฌุฑุง',
      'completed': 'ุชฺฉูู ุดุฏู',
      'awaiting_collection': 'ุฏุฑ ุงูุชุธุงุฑ ุฌูุนโุขูุฑ',
      'collected': 'ุฌูุนโุขูุฑ ุดุฏู',
      'closed': 'ุจุณุชู ุดุฏู',
      'rejected': 'ุฑุฏ ุดุฏู',
      'cancelled': 'ูุบู ุดุฏู'
    };

    const executionStageMap: Record<string, string> = {
      'pending_approval': 'ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ',
      'approved': 'ุชุงุฏ ุดุฏู',
      'scheduled': 'ุฒูุงูโุจูุฏ ุดุฏู',
      'in_progress': 'ุฏุฑ ุญุงู ุงุฌุฑุง',
      'order_executed': 'ุงุฌุฑุง ุดุฏู',
      'awaiting_collection': 'ุฏุฑ ุงูุชุธุงุฑ ุฌูุนโุขูุฑ',
      'in_collection': 'ุฏุฑ ุญุงู ุฌูุนโุขูุฑ',
      'collected': 'ุฌูุนโุขูุฑ ุดุฏู',
      'awaiting_payment': 'ุฏุฑ ุงูุชุธุงุฑ ูพุฑุฏุงุฎุช',
      'completed': 'ุชฺฉูู ุดุฏู'
    };

    // ูุญุงุณุจู ุขูุงุฑ ฺฉู
    let totalPaymentAmount = 0;
    let paidOrders = 0;
    let pendingOrders = 0;
    let inProgressOrders = 0;
    let completedOrders = 0;

    orders.forEach((order: any) => {
      if (order.payment_amount) {
        totalPaymentAmount += Number(order.payment_amount);
      }
      
      switch (order.status) {
        case 'pending':
          pendingOrders++;
          break;
        case 'in_progress':
        case 'approved':
          inProgressOrders++;
          break;
        case 'completed':
        case 'closed':
        case 'collected':
          completedOrders++;
          break;
      }
    });

    // ุณุงุฎุช ูุชู ุงุทูุงุนุงุช ุณูุงุฑุดุงุช
    let ordersContext = `

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฆ ุงุทูุงุนุงุช ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ (${orders.length} ุณูุงุฑุด)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุขูุงุฑ ฺฉู:
- ุชุนุฏุงุฏ ฺฉู ุณูุงุฑุดุงุช: ${orders.length}
- ุณูุงุฑุดุงุช ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ: ${pendingOrders}
- ุณูุงุฑุดุงุช ุฏุฑ ุญุงู ุงุฌุฑุง: ${inProgressOrders}
- ุณูุงุฑุดุงุช ุชฺฉูู ุดุฏู: ${completedOrders}
- ูุฌููุน ูุจุงูุบ ูพุฑุฏุงุฎุช ุซุจุช ุดุฏู: ${totalPaymentAmount.toLocaleString('fa-IR')} ุชููุงู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูุณุช ุณูุงุฑุดุงุช:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
`;

    orders.forEach((order: any, index: number) => {
      const provinceName = order.provinces?.name || 'ูุงูุดุฎุต';
      const districtName = order.districts?.name || '';
      const subcategoryName = order.subcategories?.name || 'ูุงูุดุฎุต';
      const statusFa = statusMap[order.status] || order.status;
      const executionStageFa = order.execution_stage ? executionStageMap[order.execution_stage] || order.execution_stage : '-';
      const createdDate = new Date(order.created_at).toLocaleDateString('fa-IR');
      
      ordersContext += `
${index + 1}. ุณูุงุฑุด ${order.code}:
   - ููุน ุฎุฏูุงุช: ${subcategoryName}
   - ุขุฏุฑุณ: ${provinceName}${districtName ? ` - ${districtName}` : ''} - ${order.address || ''}${order.detailed_address ? ` (${order.detailed_address})` : ''}
   - ูุถุนุช: ${statusFa}
   - ูุฑุญูู ุงุฌุฑุง: ${executionStageFa}
   - ูุจูุบ ูพุฑุฏุงุฎุช: ${order.payment_amount ? Number(order.payment_amount).toLocaleString('fa-IR') + ' ุชููุงู' : 'ุชุนู ูุดุฏู'}
   - ุชุงุฑุฎ ุซุจุช: ${createdDate}
   ${order.execution_start_date ? `- ุชุงุฑุฎ ุดุฑูุน ุงุฌุฑุง: ${new Date(order.execution_start_date).toLocaleDateString('fa-IR')}` : ''}
   ${order.notes ? `- ุงุฏุฏุงุดุช: ${order.notes}` : ''}
`;
    });

    ordersContext += `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูฺฉุชู ููู ุจุฑุง ูพุงุณุฎฺฏู:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ููุช ฺฉุงุฑุจุฑ ุงุฒ ุณูุงุฑุดุงุชุด ูโูพุฑุณุฏุ ุงุฒ ุงุทูุงุนุงุช ุจุงูุง ุงุณุชูุงุฏู ฺฉู
- ุงฺฏุฑ ุฏุฑุจุงุฑู ฺฉุฏ ุณูุงุฑุด ุฎุงุต ูพุฑุณุฏุ ุงุทูุงุนุงุช ุขู ุณูุงุฑุด ุฑุง ุจุฏู
- ุงฺฏุฑ ุฏุฑุจุงุฑู ูุฌููุน ูพุฑุฏุงุฎุชโูุง ูพุฑุณุฏุ ุงุฒ ุขูุงุฑ ฺฉู ุงุณุชูุงุฏู ฺฉู
- ุงฺฏุฑ ุฏุฑุจุงุฑู ูุถุนุช ุณูุงุฑุด ุฎุงุต ูพุฑุณุฏุ ูุถุนุช ุขู ุฑุง ุจฺฏู
- ุงฺฏุฑ ุฏุฑุจุงุฑู ุขุฏุฑุณ ุฎุงุต ูพุฑุณุฏุ ุณูุงุฑุดุงุช ุขู ุขุฏุฑุณ ุฑุง ููุชุฑ ฺฉู
`;

    return ordersContext;
  } catch (error) {
    console.error('Error getting user orders context:', error);
    return '';
  }
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { messages, userRole, imageBase64, userId } = await req.json();
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
    const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");
    
    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    // ุงูุฒูุฏู ุงุทูุงุนุงุช ููุด ฺฉุงุฑุจุฑ ุจู ูพุฑุงููพุช ุณุณุชู
    let contextualPrompt = SYSTEM_PROMPT;
    
    // ุงฺฏุฑ ฺฉุงุฑุจุฑ ูุงฺฏู ฺฉุฑุฏูุ ุงุทูุงุนุงุช ุณูุงุฑุดุงุชุด ุฑุง ุจฺฏุฑ
    if (userId && SUPABASE_URL && SUPABASE_SERVICE_ROLE_KEY) {
      const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
      const ordersContext = await getUserOrdersContext(supabase, userId);
      contextualPrompt += ordersContext;
    }
    
    if (userRole) {
      contextualPrompt += `\n\nููุด ฺฉุงุฑุจุฑ ูุนู: ${userRole}`;
      
      if (userRole === 'manager' || userRole === 'admin') {
        contextualPrompt += `\nุงู ฺฉุงุฑุจุฑ ฺฉ ูุฏุฑ ุงุณุช. ูโุชูุงู ุงุทูุงุนุงุช ุจุดุชุฑ ุฏุฑุจุงุฑู ูุฏุฑุช ุณูุงุฑุดุงุช ู ฺฏุฒุงุฑุดุงุช ุงุฑุงุฆู ุฏู.`;
      } else if (userRole === 'customer') {
        contextualPrompt += `\nุงู ฺฉุงุฑุจุฑ ฺฉ ูุดุชุฑ ุงุณุช. ุจู ุงู ุฏุฑ ุซุจุช ุณูุงุฑุด ู ูพฺฏุฑ ุณูุงุฑุดุงุช ฺฉูฺฉ ฺฉู.`;
      }
    }

    // ุณุงุฎุช ูพุงูโูุง ุจุง ูพุดุชุจุงู ุงุฒ ุชุตูุฑ
    const formattedMessages = messages.map((msg: { role: string; content: string }, index: number) => {
      // ุงฺฏุฑ ุชุตูุฑ ุฏุงุฑู ู ุงู ุขุฎุฑู ูพุงู ฺฉุงุฑุจุฑ ุงุณุช
      if (imageBase64 && msg.role === 'user' && index === messages.length - 1) {
        return {
          role: msg.role,
          content: [
            {
              type: "text",
              text: msg.content + "\n\nุชูุถุญ ููู: ฺฉุงุฑุจุฑ ฺฉ ุชุตูุฑ ุงุฒ ุณุงุช ุงูุฑู ูุฑุณุชุงุฏู ุงุณุช. ุงฺฏุฑ ุชุตูุฑ ูุฑุจูุท ุจู ฺฉุฑู ุฒูู ุทูุง ุงุณุชุ ุชูุถุญ ุจุฏู ฺฉู ุงู ฺฉุฑู ููุงุฏ ฺฏุณุชุฑุฏฺฏ ุฎุฏูุงุช ุงูุฑู ุฏุฑ ุณุฑุงุณุฑ ุงุฑุงู ุงุณุช ู ูุดุงูโุฏููุฏู ฺฉูุช ุทูุง ุฎุฏูุงุช ูุงุณุช. ุงฺฏุฑ ุชุตูุฑ ูุฑุจูุท ุจู ุจุฎุด ุฏฺฏุฑ ุงุฒ ุณุงุช ุงุณุชุ ุขู ุฑุง ุชูุถุญ ุจุฏู. ุงฺฏุฑ ุชุตูุฑ ุงุตูุงู ูุฑุจูุท ุจู ุณุงุช ูุณุชุ ููุฏุจุงูู ุจฺฏู ฺฉู ููุท ุฏุฑุจุงุฑู ุฎุฏูุงุช ุงูุฑู ูโุชูุงู ฺฉูฺฉ ฺฉู."
            },
            {
              type: "image_url",
              image_url: {
                url: `data:image/jpeg;base64,${imageBase64}`
              }
            }
          ]
        };
      }
      return { role: msg.role, content: msg.content };
    });

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-flash",
        messages: [
          { role: "system", content: contextualPrompt },
          ...formattedMessages,
        ],
        stream: true,
      }),
    });

    if (!response.ok) {
      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "ุณุฑูุณ ูพุฑูุดุบูู ุงุณุช. ูุทูุงู ฺูุฏ ูุญุธู ุตุจุฑ ฺฉูุฏ." }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (response.status === 402) {
        return new Response(JSON.stringify({ error: "ุณุฑูุณ ูููุชุงู ุฏุฑ ุฏุณุชุฑุณ ูุณุช." }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      return new Response(JSON.stringify({ error: "ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด ุฏุฑุฎูุงุณุช" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (error) {
    console.error("Assistant chat error:", error);
    return new Response(JSON.stringify({ error: error instanceof Error ? error.message : "ุฎุทุง ูุงุดูุงุฎุชู" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});