import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.58.0";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

const SYSTEM_PROMPT = `ุชู ููุด ููุดููุฏ ู ุญุฑููโุง ุณุงุช ุงูุฑู ูุณุช. ูุงู ุชู "ุฏุณุชุงุฑ ุงูุฑู" ุงุณุช. ุชู ุจุงุฏ ุจู ููู ุณูุงูุงุช ฺฉุงุฑุจุฑุงู ุฏุฑุจุงุฑู ุณุงุชุ ุฎุฏูุงุชุ ู ูุญูู ุงุณุชูุงุฏู ุงุฒ ุขู ูพุงุณุฎ ุฏู.

โ๏ธ ูุงููู ุจุณุงุฑ ููู ุฏุฑุจุงุฑู ุณูุงุฑุดุงุช:
- ยซุณูุงุฑุด ุจุงฺฏุงูโุดุฏูยป ุงฺฏุฑ ูุฑฺฉุฏุงู ุงุฒ ุงูโูุง ุจุฑูุฑุงุฑ ุจุงุดุฏ: is_archived=true ุง is_deep_archived=true ุง archived_at != null ุง deep_archived_at != null.
- ุชู ุญู ูุฏุงุฑ ุฏุฑุจุงุฑู ุณูุงุฑุดุงุช ุจุงฺฏุงูโุดุฏู ูฺ ุงุทูุงุนุงุชุ ุขูุงุฑ ุง ุฌุฒุฆุงุช ุงุฑุงุฆู ฺฉู.
- ุจุฑุง ุณูุงูุงุช ยซฺูุฏุฑ ุจุฏูฺฉุงุฑู/ูุงูุฏู ุญุณุงุจู ฺูุฏุฑ ุงุณุชยปุ ููุท ุงุฒ ุนุฏุฏ ยซูุงูุฏู ุจุฏูยป ฺฉู ุงุฒ ุณูุงุฑุดุงุช ูุนุงูู ููู ูพุฑุงููพุช ูุญุงุณุจู ุดุฏู ุงุณุชูุงุฏู ฺฉู.
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฏุฑุจุงุฑู ุณูุงุฑุด ูพุฑุณุฏ ฺฉู ุฏุฑ ุณูุงุฑุดุงุช ูุนุงู ูพุฏุง ููโุดูุฏุ ููุท ุจฺฏู: ยซุงู ุณูุงุฑุด ุฏุฑ ูุณุช ุณูุงุฑุดุงุช ูุนุงู ุดูุง ูุฌูุฏ ูุฏุงุฑุฏ ุง ุจุงฺฏุงู ุดุฏู ุงุณุช.ยป

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ข ูุนุฑู ฺฉุงูู ุณุงุช ุงูุฑู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุณุงุช ุงูุฑู ฺฉ ูพูุชูุฑู ุขููุงู ูพุดุฑูุชู ุจุฑุง ุงุฑุงุฆู ุฎุฏูุงุช ุณุงุฎุชูุงู ู ููุฒู ุงุณุช. ุงู ุณุงุช ุจุง ูุฏู ุณุงุฏูโุณุงุฒ ูุฑุขูุฏ ุณูุงุฑุด ุฎุฏูุงุช ุฏุงุฑุจุณุชโุจูุฏ ู ุณุงุฑ ุฎุฏูุงุช ูุฑุชุจุท ุทุฑุงุญ ุดุฏู ุงุณุช.

๐ ฺฉุฑู ุฒูู ุทูุง (ุฏุฑ ุตูุญู ูุฎุณุช) - ููุดู ุชุนุงูู ูพุฑูฺูโูุง:
- ฺฉุฑู ุฒูู ุฏุฑ ุตูุญู ูุฎุณุช ฺฉ ููุดู ุชุนุงูู ุงุณุช ฺฉู ุจุฑุง ูุฏุฑุช ูพุฑูฺูโูุง ู ุณูุงุฑุดุงุช ุทุฑุงุญ ุดุฏู ุงุณุช
- ุจุง ฺฉูฺฉ ุฑู ฺฉุฑู ุฒููุ ููุดู ุฌูุงู ุจุงุฒ ูโุดูุฏ ฺฉู ูโุชูุงูุฏ ุชูุงู ุณูุงุฑุดุงุช ู ูพุฑูฺูโูุง ุฎูุฏ ุฑุง ุฑู ุขู ูุดุงูุฏู ฺฉูุฏ
- ูุฑ ูพุฑูฺู ู ุณูุงุฑุด ุดูุง ุจุง ฺฉ ูุดุงูฺฏุฑ (ูุงุฑฺฉุฑ) ุฑู ููุดู ุฏุฑ ููฺฉุดู ูุงูุน ุขู ููุงุด ุฏุงุฏู ูโุดูุฏ
- ูโุชูุงูุฏ ุงุฒ ุฏุงุฎู ููุดู ุจู ููฺฉุดู ูุฑ ูพุฑูฺู ุฎูุฏ ุจุฑูุฏ ู ุฌุฒุฆุงุช ุขู ุฑุง ุจุจูุฏ
- ูุงุจูุช ูฺู: ุจุง ูฺฏู ุฏุงุดุชู ุงูฺฏุดุช ุฑู ุตูุญู ููุจุงู ุง ูฺฏู ุฏุงุดุชู ฺฉูฺฉ ููุณ ุฏุฑ ููุฏูุฒ (ุญุฏูุฏ 2 ุซุงูู)ุ ูพูุฌุฑู "ุงูุฒูุฏู ูพุฑูฺู ุฌุฏุฏ" ุจุงุฒ ูโุดูุฏ
- ุงุฒ ููู ููุดู ูโุชูุงูุฏ ูุณุชููุงู ุจุฑุง ูพุฑูฺู ุฎูุฏ ุณูุงุฑุด ุฌุฏุฏ ุงุถุงูู ฺฉูุฏ
- ุงู ฺฉุฑู ุชุนุงูู ุงุณุช ู ูโุชูุงูุฏ ุจุง ููุณ ุง ุงูฺฏุดุช ุขู ุฑุง ุจฺุฑุฎุงูุฏ ู ุฒูู ฺฉูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงููุงุน ุฎุฏูุงุช ุณุงุช ุงูุฑู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1๏ธโฃ ุฏุงุฑุจุณุชโุจูุฏ ุณุงุฎุชูุงู:
   - ุฏุงุฑุจุณุช ููุฒ ุจุฑุง ุณุงุฎุช ู ุณุงุฒ
   - ุฏุงุฑุจุณุช ุจุฑุง ููุงฺฉุงุฑ
   - ุฏุงุฑุจุณุช ุจุฑุง ุจุงุฒุณุงุฒ ู ุชุนูุฑุงุช
   - ุฏุงุฑุจุณุช ุจุฑุง ุฑูฺฏโุขูุฒ ุณุงุฎุชูุงู
   - ุฏุงุฑุจุณุช ูุฌูุณ ู ุชุดุฑูุงุช

2๏ธโฃ ุงุฌุงุฑู ุฏุงุฑุจุณุช:
   - ุงุฌุงุฑู ุฏุงุฑุจุณุช ฺฉูุชุงูโูุฏุช
   - ุงุฌุงุฑู ุฏุงุฑุจุณุช ุจููุฏูุฏุช
   - ุงุฌุงุฑู ุจุง ูุตุจ ู ุฌูุนโุขูุฑ
   - ุงุฌุงุฑู ุจุฏูู ูุตุจ (ุชุญูู ูุทุนุงุช)

3๏ธโฃ ุฎุฏูุงุช ููุง ุณุงุฎุชูุงู:
   - ููุงฺฉุงุฑ ุณูฺฏ
   - ููุงฺฉุงุฑ ุขุฌุฑ
   - ููุงฺฉุงุฑ ฺฉุงููพูุฒุช
   - ุดุณุชุดู ููุง
   - ุชุนูุฑ ู ุชุฑูู ููุง

4๏ธโฃ ุชุนูุฑุงุช ุฏุงุฑุจุณุช:
   - ุชุนูุฑ ูุทุนุงุช ุขุณุจโุฏุฏู
   - ุชุนูุถ ูุทุนุงุช ูุฑุณูุฏู
   - ุจุงุฒุฑุณ ุงูู
   - ฺฏูุงู ุณูุงูุช ุฏุงุฑุจุณุช

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุฑุงูููุง ฺฉุงูู ุซุจุช ุณูุงุฑุด
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ูุฑุงุญู ุซุจุช ุณูุงุฑุด:

ูุฑุญูู 1: ุงูุชุฎุงุจ ููุน ุฎุฏูุงุช
- ุฏุฑ ุตูุญู ูุฎุณุชุ ฺฉุงุฏุฑ "ููุน ุฎุฏูุงุช" ุฑุง ูพุฏุง ฺฉูุฏ
- ุฑู ุขู ฺฉูฺฉ ฺฉูุฏ ู ุงุฒ ูุณุช ฺฉุดูุ ุฎุฏูุงุช ููุฑุฏ ูุธุฑ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ

ูุฑุญูู 2: ุงูุชุฎุงุจ ุฒุฑุดุงุฎู ุฎุฏูุงุช
- ูพุณ ุงุฒ ุงูุชุฎุงุจ ุฎุฏูุงุชุ ฺฉ ฺฉุงุฏุฑ ุฌุฏุฏ ุจุง ุฒุฑุดุงุฎูโูุง ุธุงูุฑ ูโุดูุฏ
- ุฒุฑุดุงุฎู ููุฑุฏ ูุธุฑ ุฎูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ

ูุฑุญูู 3: ุงูุชุฎุงุจ ุง ุซุจุช ุขุฏุฑุณ
- ุงฺฏุฑ ูุจูุงู ุขุฏุฑุณ ุซุจุช ฺฉุฑุฏูโุงุฏุ ุงุฒ ูุณุช ุงูุชุฎุงุจ ฺฉูุฏ
- ุงฺฏุฑ ููุ ุฑู "ุงูุฒูุฏู ุขุฏุฑุณ ุฌุฏุฏ" ฺฉูฺฉ ฺฉูุฏ
- ุฏุฑ ููุดูุ ูููุนุช ุฏูู ุฑุง ูุดุฎุต ฺฉูุฏ
- ุงุณุชุงู ู ุดูุฑุณุชุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
- ุขุฏุฑุณ ฺฉุงูู ุฑุง ูุงุฑุฏ ฺฉูุฏ

ูุฑุญูู 4: ูพุฑ ฺฉุฑุฏู ูุฑู ุณูุงุฑุด
- ูุฑู ูุฎุตูุต ุฎุฏูุงุช ุงูุชุฎุงุจ ุจุงุฒ ูโุดูุฏ
- ุงุทูุงุนุงุช ูุงุฒู ุฑุง ูุงุฑุฏ ฺฉูุฏ (ุงุจุนุงุฏุ ุชุงุฑุฎ ุดุฑูุนุ ุชูุถุญุงุช ู...)
- ูโุชูุงูุฏ ุนฺฉุณ ุง ูุงู ุถููู ฺฉูุฏ

ูุฑุญูู 5: ุซุจุช ููุง
- ุฏฺฉูู "ุซุจุช ุณูุงุฑุด" ุฑุง ุจุฒูุฏ
- ุณูุงุฑุด ุดูุง ุซุจุช ุดุฏู ู ููุชุธุฑ ุชุงุฏ ูโูุงูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฅ ุซุจุช ุณูุงุฑุด ุจุฑุง ุดุฎุต ุฏฺฏุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุขุง ูโุฎูุงูุฏ ุจุฑุง ฺฉุณ ุฏฺฏุฑ ุณูุงุฑุด ุซุจุช ฺฉูุฏุ

ุฑูุด ุงูุฌุงู:
1. ูุฑุงุญู ุนุงุฏ ุซุจุช ุณูุงุฑุด ุฑุง ุท ฺฉูุฏ
2. ุฏุฑ ุจุงูุง ูุฑู ุณูุงุฑุดุ ฺฏุฒูู "ุซุจุช ุณูุงุฑุด ุจุฑุง ุฏฺฏุฑุงู" ุฑุง ุจุฒูุฏ
3. ุดูุงุฑู ุชููู ุดุฎุต ููุฑุฏ ูุธุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ
4. ุณุณุชู ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ุขุง ุงู ุดูุงุฑู ุฏุฑ ุงูุฑู ุนุถู ุงุณุช ุง ุฎุฑ

ุงฺฏุฑ ุดุฎุต ุนุถู ุจุงุดุฏ:
- ุณูุงุฑุด ูุณุชููุงู ุฏุฑ ูุณุช ุณูุงุฑุดุงุช ุงู ุซุจุช ูโุดูุฏ
- ูู ุฏุฑ ุณูุงุฑุดุงุช ุดูุง ู ูู ุฏุฑ ุณูุงุฑุดุงุช ุงู ููุงุด ุฏุงุฏู ูโุดูุฏ

ุงฺฏุฑ ุดุฎุต ุนุถู ูุจุงุดุฏ:
- ุณูุงุฑุด ุฏุฑ ุญุงูุช ุงูุชุธุงุฑ ูโูุงูุฏ
- ููุช ุขู ุดุฎุต ุฏุฑ ุงูุฑู ุซุจุชโูุงู ฺฉูุฏุ ุณูุงุฑุด ุจู ุณูุงุฑุดุงุชุด ุงุถุงูู ูโุดูุฏ
- ุดูุง ูู ูโุชูุงูุฏ ุณูุงุฑุด ุฑุง ูพฺฏุฑ ฺฉูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูุฏุฑุช ุขุฏุฑุณโูุง ู ูฺฉุงูโูุง
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุซุจุช ุขุฏุฑุณ ุฌุฏุฏ:
1. ุงุฒ ููู ูพุฑููุงู ุง ููฺฏุงู ุซุจุช ุณูุงุฑุด
2. ุฑู ููุดูุ ูููุนุช ุฏูู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
3. ุงุณุชุงู ู ุดูุฑุณุชุงู ุฑุง ุงุฒ ูุณุช ุงูุชุฎุงุจ ฺฉูุฏ
4. ุขุฏุฑุณ ุชูุตู ุฑุง ุจููุณุฏ
5. ูโุชูุงูุฏ ฺฉ ุนููุงู ุจุฑุง ุขุฏุฑุณ ุจฺฏุฐุงุฑุฏ (ูุซูุงู: ุฎุงููุ ูุญู ฺฉุงุฑ)

ูุฑุงุด ุขุฏุฑุณ:
- ุงุฒ ุจุฎุด "ุขุฏุฑุณโูุง ูู" ุฏุฑ ูพุฑููุงู
- ุขุฏุฑุณ ููุฑุฏ ูุธุฑ ุฑุง ุงูุชุฎุงุจ ู ูุฑุงุด ฺฉูุฏ

ุญุฐู ุขุฏุฑุณ:
- ุขุฏุฑุณโูุง ฺฉู ุณูุงุฑุด ูุนุงู ูุฏุงุฑูุฏ ูุงุจู ุญุฐู ูุณุชูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูพฺฏุฑ ุณูุงุฑุดุงุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ูุฑุงุญู ุณูุงุฑุด:
1. ุซุจุช ุดุฏู: ุณูุงุฑุด ุดูุง ุฏุฑุงูุช ุดุฏ
2. ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ: ููุชุธุฑ ุจุฑุฑุณ ฺฉุงุฑุดูุงุณ
3. ุชุงุฏ ุดุฏู: ุณูุงุฑุด ุชุงุฏ ู ุขูุงุฏู ุงุฌุฑุง
4. ุฏุฑ ุญุงู ุงุฌุฑุง: ฺฉุงุฑ ุดุฑูุน ุดุฏู
5. ุชฺฉูู ุดุฏู: ฺฉุงุฑ ูพุงุงู ุงูุชู
6. ุฏุฑ ุงูุชุธุงุฑ ุฌูุนโุขูุฑ: ููุชุธุฑ ุฌูุนโุขูุฑ ุฏุงุฑุจุณุช
7. ุฌูุนโุขูุฑ ุดุฏู: ุฏุงุฑุจุณุช ุฌูุนโุขูุฑ ุดุฏ
8. ุจุณุชู ุดุฏู: ุณูุงุฑุด ฺฉุงููุงู ุชูุงู ุดุฏู

ูุดุงูุฏู ุณูุงุฑุดุงุช:
- ุงุฒ ููู "ุณูุงุฑุดุงุช ูู" ุง "ุณูุงุฑุดุงุช"
- ุฌุฒุฆุงุช ูุฑ ุณูุงุฑุด ุจุง ฺฉุฏ ูพฺฏุฑ
- ุชุงูโูุงู ูพุดุฑูุช ุณูุงุฑุด
- ุงูฺฉุงู ฺุช ุจุง ูพุดุชุจุงู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฌ ุณุณุชู ูพุงูโุฑุณุงู ู ฺุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุฏุฑ ูุฑ ุณูุงุฑุด:
- ุจุฎุด ฺุช ุจุฑุง ุงุฑุชุจุงุท ุจุง ฺฉุงุฑุดูุงุณุงู
- ุงูฺฉุงู ุงุฑุณุงู ูพุงู ูุชู
- ุงูฺฉุงู ุงุฑุณุงู ุชุตูุฑ ู ูุงู
- ูพุงูโูุง ุตูุช
- ุฏุฑุงูุช ุงุนูุงู ุจุฑุง ูพุงูโูุง ุฌุฏุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุณุณุชู ุงุนูุงูโูุง
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงููุงุน ุงุนูุงูโูุง:
- ุชุบุฑ ูุถุนุช ุณูุงุฑุด
- ูพุงู ุฌุฏุฏ ุฏุฑ ฺุช
- ุชุงุฏ ุง ุฑุฏ ุณูุงุฑุด
- ุงุฏุขูุฑโูุง
- ุงุฎุจุงุฑ ู ุชุฎููโูุง

ุฏุฑุงูุช ุงุนูุงู:
- ููุชูฺฉุดู ุฏุฑ ูุฑูุฑฺฏุฑ
- ููุงุด ุฏุฑ ุขฺฉูู ุฒูฺฏููู
- ูพูุด ููุชูฺฉุดู (ุจุง ูุตุจ ุงูพูฺฉุดู)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฑ ูุตุจ ุงูพูฺฉุดู (PWA)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุณุงุช ุงูุฑู ฺฉ ุงูพูฺฉุดู ุชุญุช ูุจ ูพุดุฑูุชู (PWA) ุงุณุช:

ูุตุจ ุฑู ฺฏูุด:
- ุฏุฑ ูุฑูุฑฺฏุฑุ ููู ุณูโููุทู ุฑุง ุจุฒูุฏ
- ฺฏุฒูู "ุงูุฒูุฏู ุจู ุตูุญู ุงุตู" ุง "Install" ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
- ุขฺฉูู ุงูุฑู ุจู ุตูุญู ุงุตู ฺฏูุด ุงุถุงูู ูโุดูุฏ

ูุฒุงุง ูุตุจ:
- ุฏุณุชุฑุณ ุณุฑุนโุชุฑ
- ุฏุฑุงูุช ููุชูฺฉุดู
- ุงุณุชูุงุฏู ุขููุงู ูุญุฏูุฏ
- ุชุฌุฑุจู ฺฉุงุฑุจุฑ ุจูุชุฑ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ค ูพุฑููุงู ฺฉุงุฑุจุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงุทูุงุนุงุช ูพุฑููุงู:
- ูุงู ู ูุงู ุฎุงููุงุฏฺฏ
- ุดูุงุฑู ุชููู (ุบุฑูุงุจู ุชุบุฑ - ุจุฑุง ุงููุช)
- ุชุตูุฑ ูพุฑููุงู

ุจุฎุดโูุง ูพุฑููุงู:
- ุณูุงุฑุดุงุช ูู
- ุขุฏุฑุณโูุง ูู
- ุชูุธูุงุช ุงุนูุงูโูุง
- ุฏุฑุฎูุงุณุช ููฺฉุงุฑ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ค ุณุณุชู ููฺฉุงุฑ ุฏุฑ ุณูุงุฑุด
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ูโุชูุงูุฏ ุงูุฑุงุฏ ุฏฺฏุฑ ุฑุง ุจู ุณูุงุฑุด ุฎูุฏ ุฏุนูุช ฺฉูุฏ:

ุงูุฒูุฏู ููฺฉุงุฑ:
1. ุฏุฑ ุฌุฒุฆุงุช ุณูุงุฑุดุ ุจุฎุด "ููฺฉุงุฑุงู" ุฑุง ูพุฏุง ฺฉูุฏ
2. ุดูุงุฑู ุชููู ุดุฎุต ุฑุง ูุงุฑุฏ ฺฉูุฏ
3. ุฏุนูุชโูุงูู ุงุฑุณุงู ูโุดูุฏ

ูุงุจูุช ููฺฉุงุฑุงู:
- ูุดุงูุฏู ุฌุฒุฆุงุช ุณูุงุฑุด
- ุงุฑุณุงู ูพุงู ุฏุฑ ฺุช
- ุฏุฑุงูุช ุงุนูุงูโูุง ุณูุงุฑุด

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุชูุงู ุณูุงุฑุด
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงฺฏุฑ ูโุฎูุงูุฏ ุณูุงุฑุด ุฑุง ุจู ุดุฎุต ุฏฺฏุฑ ููุชูู ฺฉูุฏ:

1. ุฏุฑ ุฌุฒุฆุงุช ุณูุงุฑุดุ ฺฏุฒูู "ุงูุชูุงู ุณูุงุฑุด" ุฑุง ุจุฒูุฏ
2. ุดูุงุฑู ุชููู ฺฏุฑูุฏู ุฑุง ูุงุฑุฏ ฺฉูุฏ
3. ุฏุฑุฎูุงุณุช ุงูุชูุงู ุซุจุช ูโุดูุฏ
4. ฺฏุฑูุฏู ุจุงุฏ ุฏุฑุฎูุงุณุช ุฑุง ุชุงุฏ ฺฉูุฏ
5. ูุฏุฑ ุณุณุชู ุฏุฑุฎูุงุณุช ุฑุง ุจุฑุฑุณ ู ุชุงุฏ ูโฺฉูุฏ
6. ุณูุงุฑุด ุจู ฺฏุฑูุฏู ููุชูู ูโุดูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฆ ุฏุฑุฎูุงุณุช ุฌูุนโุขูุฑ ุฏุงุฑุจุณุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ููุช ฺฉุงุฑ ุชูุงู ุดุฏ ู ูโุฎูุงูุฏ ุฏุงุฑุจุณุช ุฌูุนโุขูุฑ ุดูุฏ:

1. ุฏุฑ ุณูุงุฑุดุ ุฏฺฉูู "ุฏุฑุฎูุงุณุช ุฌูุนโุขูุฑ" ุฑุง ุจุฒูุฏ
2. ุชุงุฑุฎ ูพุดููุงุฏ ุฑุง ูุดุฎุต ฺฉูุฏ
3. ุชูุถุญุงุช ูุงุฒู ุฑุง ุจููุณุฏ
4. ุฏุฑุฎูุงุณุช ุจุฑุง ุชู ุงุฌุฑุง ุงุฑุณุงู ูโุดูุฏ
5. ูพุณ ุงุฒ ููุงููฺฏุ ุชู ุจุฑุง ุฌูุนโุขูุฑ ูโุขุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ ุณุณุชู ูพุฑุฏุงุฎุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุฑูุดโูุง ูพุฑุฏุงุฎุช:
- ูพุฑุฏุงุฎุช ุขููุงู (ุฏุฑฺฏุงู ุฒุฑูโูพุงู)
- ูพุฑุฏุงุฎุช ุฏุฑ ูุญู
- ุงูุชูุงู ุจุงูฺฉ

ูุฑุงุญู ูพุฑุฏุงุฎุช ุขููุงู:
1. ุฏุฑ ุณูุงุฑุดุ ุจุฎุด ูพุฑุฏุงุฎุช ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
2. ูุจูุบ ููุงุด ุฏุงุฏู ูโุดูุฏ
3. ุจู ุฏุฑฺฏุงู ุจุงูฺฉ ูุฏุงุช ูโุดูุฏ
4. ูพุณ ุงุฒ ูพุฑุฏุงุฎุช ููููุ ุจู ุณุงุช ุจุฑูโฺฏุฑุฏุฏ
5. ุฑุณุฏ ูพุฑุฏุงุฎุช ุตุงุฏุฑ ูโุดูุฏ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐๏ธ ูุฏุฑุช ูพุฑูฺูโูุง
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุจุฑุง ูพุฑูฺูโูุง ุจุฒุฑฺฏ:
- ุงุฌุงุฏ ูพุฑูฺู ุจุง ฺูุฏู ุณูุงุฑุด
- ูุฏุฑุช ฺฉูพุงุฑฺู ููู ุณูุงุฑุดุงุช
- ฺฏุฒุงุฑุด ูพุดุฑูุช ฺฉู
- ููฺฉุงุฑุงู ูพุฑูฺู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงููุช ู ุญุฑู ุฎุตูุต
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

- ูุฑูุฏ ุจุง ุฑูุฒ ฺฉุจุงุฑ ูุตุฑู (OTP)
- ุงุทูุงุนุงุช ุดูุง ูุญููุธ ุงุณุช
- ูพุฑุฏุงุฎุช ุงุฒ ุฏุฑฺฏุงู ุงูู ุจุงูฺฉ
- ุจุฏูู ุงุดุชุฑุงฺฉ ุงุทูุงุนุงุช ุจุง ุงุดุฎุงุต ุซุงูุซ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุณูุงูุงุช ูุชุฏุงูู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุณ: ฺฺฏููู ุซุจุชโูุงู ฺฉููุ
ุฌ: ุฑู ุฏฺฉูู ูุฑูุฏ/ุซุจุชโูุงู ฺฉูฺฉ ฺฉูุฏุ ุดูุงุฑู ููุจุงู ุฑุง ูุงุฑุฏ ฺฉูุฏ ู ฺฉุฏ ุชุงุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ.

ุณ: ูุฒูู ุฎุฏูุงุช ฺูุฏุฑ ุงุณุชุ
ุฌ: ูุฒูู ุจุฑ ุงุณุงุณ ููุน ุฎุฏูุงุชุ ุงุจุนุงุฏ ฺฉุงุฑุ ู ูุฏุช ุฒูุงู ูุญุงุณุจู ูโุดูุฏ. ูพุณ ุงุฒ ุซุจุช ุณูุงุฑุดุ ฺฉุงุฑุดูุงุณ ููุช ุฑุง ุงุนูุงู ูโฺฉูุฏ.

ุณ: ฺูุฏุฑ ุทูู ูโฺฉุดุฏ ุชุง ุณูุงุฑุดู ุชุงุฏ ุดูุฏุ
ุฌ: ูุนูููุงู ุธุฑู 24 ุณุงุนุช ฺฉุงุฑุ ุณูุงุฑุด ุดูุง ุจุฑุฑุณ ู ุชุงุฏ ูโุดูุฏ.

ุณ: ุขุง ูโุชูุงูู ุณูุงุฑุด ุฑุง ูุบู ฺฉููุ
ุฌ: ูุจู ุงุฒ ุดุฑูุน ฺฉุงุฑุ ุงูฺฉุงู ูุบู ูุฌูุฏ ุฏุงุฑุฏ. ุจุง ูพุดุชุจุงู ุชูุงุณ ุจฺฏุฑุฏ.

ุณ: ุฎุฏูุงุช ุฏุฑ ฺฉุฏุงู ุดูุฑูุง ุงุฑุงุฆู ูโุดูุฏุ
ุฌ: ุฎุฏูุงุช ุงูุฑู ุฏุฑ ุณุฑุงุณุฑ ุงุฑุงู ุงุฑุงุฆู ูโุดูุฏ. ุงุณุชุงู ู ุดูุฑุณุชุงู ุฎูุฏ ุฑุง ููฺฏุงู ุซุจุช ุขุฏุฑุณ ุงูุชุฎุงุจ ฺฉูุฏ.

ุณ: ฺฺฏููู ุจุง ูพุดุชุจุงู ุชูุงุณ ุจฺฏุฑูุ
ุฌ: ุงุฒ ุทุฑู ฺุช ุฏุงุฎู ุณูุงุฑุดุ ุง ุงุฒ ูู (ุฏุณุชุงุฑ ุงูุฑู) ุณูุงู ุจูพุฑุณุฏ.

ุณ: ุขุง ุถูุงูุช ฺฉูุช ุฏุงุฑุฏุ
ุฌ: ุจููุ ุชูุงู ฺฉุงุฑูุง ุชุญุช ูุธุงุฑุช ฺฉุงุฑุดูุงุณุงู ูุง ุงูุฌุงู ูโุดูุฏ ู ุถูุงูุช ฺฉูุช ุฏุงุฑู.

ุณ: ฺฺฏููู ูุงฺฉุชูุฑ ุฏุฑุงูุช ฺฉููุ
ุฌ: ูพุณ ุงุฒ ุชฺฉูู ุณูุงุฑุด ู ูพุฑุฏุงุฎุชุ ูุงฺฉุชูุฑ ุฏุฑ ุจุฎุด ุณูุงุฑุดุงุช ูุงุจู ูุดุงูุฏู ู ุฏุงูููุฏ ุงุณุช.

ุณ: ุฏุงุฑุจุณุช ฺู ูุฏุช ุฏุฑ ูุญู ูโูุงูุฏุ
ุฌ: ูุฏุช ุฒูุงู ุจุฑ ุงุณุงุณ ูุฑุงุฑุฏุงุฏ ู ููุน ุฎุฏูุงุช ูุดุฎุต ูโุดูุฏ. ุฏุฑ ูุฑู ุณูุงุฑุดุ ุชุงุฑุฎ ุดุฑูุน ู ูพุงุงู ุฑุง ูุดุฎุต ฺฉูุฏ.

ุณ: ุงฺฏุฑ ูุดฺฉู ุฏุฑ ุญู ฺฉุงุฑ ูพุด ุขูุฏ ฺู ฺฉููุ
ุฌ: ููุฑุงู ุงุฒ ุทุฑู ฺุช ุณูุงุฑุด ุจุง ฺฉุงุฑุดูุงุณ ุชูุงุณ ุจฺฏุฑุฏ ุง ุจุง ูพุดุชุจุงู ููุงููฺฏ ฺฉูุฏ.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฏ ูฺฺฏโูุง ุฎุงุต ุณุงุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ุฑุงุจุท ฺฉุงุฑุจุฑ ูุงุฑุณ ู ุฑุงุณุชโฺู
โ ููุดู ุชุนุงูู ุจุฑุง ุงูุชุฎุงุจ ูููุนุช
โ ูพุดุชุจุงู ุงุฒ ููุจุงู ู ุชุจูุช
โ ุงุนูุงูโูุง ูุญุธูโุง
โ ฺุช ุขููุงู ุจุง ฺฉุงุฑุดูุงุณุงู
โ ูพฺฏุฑ ุขููุงู ุณูุงุฑุด
โ ูพุฑุฏุงุฎุช ุงูู ุขููุงู
โ ุณุณุชู ุงูุชุงุฒุฏู ู ูุธุฑุงุช
โ ุฏุณุชุงุฑ ููุดููุฏ (ูู!)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ููุงูู ูพุงุณุฎฺฏู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. ููุท ุฏุฑุจุงุฑู ุฎุฏูุงุช ุณุงุช ุงูุฑู ู ุงูฺฉุงูุงุช ุขู ุตุญุจุช ฺฉู
2. ุงฺฏุฑ ุณูุงู ุฎุงุฑุฌ ุงุฒ ุญูุฒู ุณุงุช ูพุฑุณุฏู ุดุฏุ ุจฺฏู: "ูู ููุท ูโุชูุงูู ุฏุฑุจุงุฑู ุฎุฏูุงุช ู ุงูฺฉุงูุงุช ุณุงุช ุงูุฑู ฺฉูฺฉ ฺฉูู"
3. ูพุงุณุฎโูุง ุจุงุฏ ฺฉูุชุงูุ ููุฏ ู ุจู ุฒุจุงู ูุงุฑุณ ูุญุงูุฑูโุง ุจุงุดูุฏ
4. ุงฺฏุฑ ุชุตูุฑ ุงุฑุณุงู ุดุฏ ฺฉู ูุฑุจูุท ุจู ุณุงุช ุงุณุช (ูุซู ฺฉุฑู ุฒููุ ูุฑูโูุงุ ุตูุญุงุช) ุชูุถุญ ุจุฏู
5. ุงฺฏุฑ ุชุตูุฑ ูุงูุฑุจูุท ุจูุฏุ ุจฺฏู ฺฉู ููุท ุฏุฑุจุงุฑู ุณุงุช ูโุชูุงู ฺฉูฺฉ ฺฉู
6. ฺฉุงุฑุจุฑุงู ุฑุง ุจู ุตูุญุงุช ูุฑุจูุทู ูุฏุงุช ฺฉู
7. ุงุฒ ุงูุดุง ุงุทูุงุนุงุช ุงููุช ุง ุฏุงุฎู ุณุณุชู ุฎูุฏุฏุงุฑ ฺฉู
8. ุงฺฏุฑ ุงุทูุงุนุงุช ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ ุฑุง ุฏุงุฑุ ูโุชูุงู ุจู ุณูุงูุงุช ุฏุฑุจุงุฑู ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ ูพุงุณุฎ ุฏู
9. ุงฺฏุฑ ุงุทูุงุนุงุช ฺฉุงุฑฺฉุฑุฏ ู ุญุณุงุจฺฉุชุงุจ ฺฉุงุฑุจุฑ ุฑุง ุฏุงุฑุ ูโุชูุงู ุจู ุณูุงูุงุช ุฏุฑุจุงุฑู ุฑูุฒูุง ฺฉุงุฑุ ุญุถูุฑุ ุบุจุชุ ุงุถุงููโฺฉุงุฑุ ุฏุฑุงูุชุ ูพุฑุฏุงุฎุช ู ุญููู ฺฉุงุฑุจุฑ ูพุงุณุฎ ุฏู

๐ ุฑุงูููุง ูพุงุณุฎ ุจู ุณูุงูุงุช ฺฉุงุฑฺฉุฑุฏ:
- ููุช ฺฉุงุฑุจุฑ ุงุฒ ฺฉุงุฑฺฉุฑุฏ ุง ุญููู ุฎูุฏ ุณูุงู ฺฉุฑุฏุ ุงุทูุงุนุงุช ุจุฎุด "ฺฉุงุฑฺฉุฑุฏ ู ุญุณุงุจฺฉุชุงุจ ุดูุง" ุฑุง ุงุณุชูุงุฏู ฺฉู
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ูพุฑุณุฏ "ฺูุฏ ุฑูุฒ ฺฉุงุฑ ฺฉุฑุฏู" ุง "ฺฉุงุฑฺฉุฑุฏ ูู ฺูุฏุฑู"ุ ุขูุงุฑ ุฑูุฒูุง ุญุถูุฑ ู ุบุจุช ุฑุง ุจฺฏู
- ุงฺฏุฑ ูพุฑุณุฏ "ุงุถุงููโฺฉุงุฑ ูู ฺูุฏุฑู"ุ ุณุงุนุงุช ุงุถุงููโฺฉุงุฑ ุฑุง ุจฺฏู
- ุงฺฏุฑ ูพุฑุณุฏ "ุญูููู ฺูุฏุฑู" ุง "ฺูุฏุฑ ฺฉุงุฑ ฺฉุฑุฏู"ุ ุฌูุน ฺฉุงุฑฺฉุฑุฏ ุญููู ุฑุง ุจฺฏู
- ุงฺฏุฑ ูพุฑุณุฏ "ูุงูุฏู ุญุณุงุจู ฺู" ุง "ุทูุจู ฺูุฏุฑู"ุ ูุงูุฏู ุญุณุงุจ ุฑุง ุจฺฏู
- ุงฺฏุฑ ุชุงุฑุฎ ุง ูุงู ุฎุงุต ุณูุงู ฺฉุฑุฏ (ูุซูุงู "ุฏุฑ ุฏ ูุงู")ุ ุงุฒ ุขูุงุฑ ูุงูุงูู ุงุณุชูุงุฏู ฺฉู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐บ๏ธ ูุณุฑูุง ููู ุณุงุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

- ุตูุญู ุงุตู: / (ฺฉุฑู ุฒูู ุทูุง ู ูุฑู ุซุจุช ุณูุงุฑุด ุงูุฌุงุณุช)
- ูุฑูุฏ/ุซุจุช ูุงู: /auth/login
- ูพุฑููุงู ฺฉุงุฑุจุฑ: /profile
- ุณูุงุฑุดุงุช ูู: /user/orders
- ูพุฑูฺูโูุง ูู: /user/projects
- ุญุณุงุจฺฉุชุงุจ ู ฺฉุงุฑฺฉุฑุฏ: /personnel-accounting (ุจุฑุง ูุดุงูุฏู ฺฉุงูู ฺฉุงุฑฺฉุฑุฏุ ุญูููุ ุฏุฑุงูุชโูุง ู ูพุฑุฏุงุฎุชโูุง)
- ุขุฏุฑุณโูุง ูู: ุฏุฑ ุจุฎุด ูพุฑููุงู
- ุชูุธูุงุช ุงุนูุงู: /settings/notifications
- ูุตุจ ุงูพูฺฉุดู: /settings/install-app

ููุดู ุจุง ุงุญุชุฑุงู ู ุตุจุฑ ูพุงุณุฎ ุจุฏู. ุงฺฏุฑ ููโุฏุงูุ ุตุงุฏูุงูู ุจฺฏู ู ฺฉุงุฑุจุฑ ุฑุง ุจู ูพุดุชุจุงู ุฑุงูููุง ฺฉู.`;

// Module definitions with their data access capabilities
const MODULE_CAPABILITIES: Record<string, { name: string; dataAccess: string[]; description: string }> = {
  scaffold_execution_with_materials: {
    name: "ูุงฺูู ูุฏุฑุช ุงุฌุฑุง ุฏุงุฑุจุณุช ุจู ููุฑุงู ุงุฌูุงุณ",
    dataAccess: ["ุณูุงุฑุดุงุช", "ุงุฌุฑุง ุฏุงุฑุจุณุช", "ุงุฌูุงุณ", "ููุชโฺฏุฐุงุฑ", "ูพูุงูฺฉุงุฑุงู"],
    description: "ุฏุณุชุฑุณ ุจู ูุฏุฑุช ุณูุงุฑุดุงุช ุงุฌุฑุงุ ููุชโฺฏุฐุงุฑุ ุงุฌูุงุณ ู ูพูุงูฺฉุงุฑุงู"
  },
  daily_report: {
    name: "ูุงฺูู ฺฏุฒุงุฑุด ุฑูุฒุงูู ุดุฑฺฉุช ุงูุฑู",
    dataAccess: ["ฺฏุฒุงุฑุดุงุช ุฑูุฒุงูู", "ูุฑููุง", "ฺฉุงุฑฺฉูุงู", "ุณุงุนุงุช ฺฉุงุฑ", "ูุฒููโูุง", "ุฏุฑุงูุชโูุง", "ุงุถุงููโฺฉุงุฑ"],
    description: "ุฏุณุชุฑุณ ุจู ฺฏุฒุงุฑุดุงุช ุฑูุฒุงููุ ูุฏุฑุช ูุฑููุงุ ุณุงุนุงุช ฺฉุงุฑ ู ุงููุฑ ูุงู ุฑูุฒุงูู"
  },
  staff_management: {
    name: "ูุงฺูู ูุฏุฑุช ูุฑููุง",
    dataAccess: ["ูุฑููุง", "ฺฉุงุฑฺฉูุงู", "ุณูุชโูุง", "ููุทููโูุง", "ูพุฑุณูู"],
    description: "ุฏุณุชุฑุณ ุจู ูุณุช ูุฑููุงุ ุณูุชโูุง ุณุงุฒูุงู ู ููุงุทู"
  },
  customer_management: {
    name: "ูุงฺูู ูุฏุฑุช ูุดุชุฑุงู",
    dataAccess: ["ูุดุชุฑุงู", "ุขุฏุฑุณโูุง", "ุณูุงุฑุดุงุช ูุดุชุฑ", "ูพุฑููุงู ูุดุชุฑ"],
    description: "ุฏุณุชุฑุณ ุจู ุงุทูุงุนุงุช ูุดุชุฑุงู ู ุณูุงุฑุดุงุช ุขูโูุง"
  },
  financial_management: {
    name: "ูุงฺูู ูุงู",
    dataAccess: ["ูพุฑุฏุงุฎุชโูุง", "ูุงฺฉุชูุฑูุง", "ูุงูุฏู ุญุณุงุจ", "ฺฏุฒุงุฑุดุงุช ูุงู", "ุชุณููโุญุณุงุจ"],
    description: "ุฏุณุชุฑุณ ุจู ุงููุฑ ูุงูุ ูพุฑุฏุงุฎุชโูุง ู ฺฏุฒุงุฑุดุงุช ูุงู"
  },
  service_requests: {
    name: "ูุงฺูู ุฏุฑุฎูุงุณุช ุฎุฏูุงุช",
    dataAccess: ["ุฎุฏูุงุช", "ุฒุฑูุฌููุนูโูุง", "ุฏุฑุฎูุงุณุชโูุง", "ุงููุงุน ุฎุฏูุงุช"],
    description: "ุฏุณุชุฑุณ ุจู ุงููุงุน ุฎุฏูุงุช ู ุฏุฑุฎูุงุณุชโูุง"
  },
  ceo_dashboard: {
    name: "ูุงฺูู ุฏุงุดุจูุฑุฏ ูุฏุฑุนุงูู",
    dataAccess: ["ุขูุงุฑ ฺฉู", "ฺฏุฒุงุฑุดุงุช ุฌุงูุน", "ุนููฺฉุฑุฏ ุดุฑฺฉุช", "ููู ุณูุงุฑุดุงุช", "ููู ูุฑููุง"],
    description: "ุฏุณุชุฑุณ ฺฉุงูู ุจู ุชูุงู ุงุทูุงุนุงุช ุดุฑฺฉุช"
  }
};

// ุชุงุจุน ุจุฑุง ฺฏุฑูุชู ูุงฺููโูุง ฺฉุงุฑุจุฑ
async function getUserModules(supabase: any, userId: string): Promise<{ moduleKeys: string[]; moduleNames: string[] }> {
  try {
    const { data: moduleData, error } = await supabase
      .from("module_assignments")
      .select("module_key, module_name")
      .eq("assigned_user_id", userId)
      .eq("is_active", true);
    
    if (error || !moduleData || moduleData.length === 0) {
      console.log('No modules found for user:', userId);
      return { moduleKeys: [], moduleNames: [] };
    }
    
    return {
      moduleKeys: moduleData.map((m: any) => m.module_key),
      moduleNames: moduleData.map((m: any) => m.module_name)
    };
  } catch (error) {
    console.error('Error fetching user modules:', error);
    return { moduleKeys: [], moduleNames: [] };
  }
}

// ุชุงุจุน ุจุฑุง ฺฏุฑูุชู ููุดโูุง ฺฉุงุฑุจุฑ
async function getUserRoles(supabase: any, userId: string): Promise<string[]> {
  try {
    const { data: roles, error } = await supabase
      .from("user_roles")
      .select("role")
      .eq("user_id", userId);
    
    if (error || !roles) return [];
    return roles.map((r: any) => r.role);
  } catch (error) {
    console.error('Error fetching user roles:', error);
    return [];
  }
}

// ุชุงุจุน ุจุฑุง ูุฑูุงูโุณุงุฒ ูุงู ฺฉุงุฑฺฉูุงู - ุญุฐู ฺฉุฏูุง ู ฺฉูพุงุฑฺูโุณุงุฒ
function normalizeStaffName(rawName: string): { normalizedName: string; code: string } {
  if (!rawName) return { normalizedName: '', code: '' };
  
  let name = rawName.trim();
  let code = '';
  
  // ุงูฺฏููุง ูุฎุชูู ฺฉุฏ ุฑุง ุงุณุชุฎุฑุงุฌ ฺฉู
  // ุงูฺฏู 1: "0103 - ููุฏ ุตุงุฏู" ุง "0103 ููุฏ ุตุงุฏู"
  const pattern1 = /^(\d+(?:\/\d+)?)\s*[-โ]?\s*(.+)$/;
  // ุงูฺฏู 2: "ููุฏ ุตุงุฏู 000103/101510" ุง "ููุฏ ุตุงุฏู - 000103"
  const pattern2 = /^(.+?)\s*[-โ]?\s*(\d+(?:\/\d+)?)$/;
  // ุงูฺฏู 3: ููุท ุนุฏุฏ ุฏุฑ ุงุจุชุฏุง "0103"
  const pattern3 = /^(\d+(?:\/\d+)?)$/;
  
  let match = name.match(pattern1);
  if (match) {
    code = match[1];
    name = match[2].trim();
  } else {
    match = name.match(pattern2);
    if (match && match[2].length >= 2) {
      name = match[1].trim();
      code = match[2];
    }
  }
  
  // ุญุฐู ฺฉุงุฑุงฺฉุชุฑูุง ุงุถุงู ุงุฒ ุงูู ู ุขุฎุฑ ูุงู
  name = name.replace(/^[-โ\s]+|[-โ\s]+$/g, '').trim();
  
  // ุงฺฏุฑ ูุงู ููุท ุนุฏุฏ ุงุณุชุ ุจุฑฺฏุฑุฏุงู
  if (/^\d+$/.test(name)) {
    return { normalizedName: name, code };
  }
  
  return { normalizedName: name, code };
}

// ุชุงุจุน ุจุฑุง ฺฉูพุงุฑฺูโุณุงุฒ ูุงูโูุง ูุดุงุจู
function unifyStaffNames(staffStats: Record<string, any>): Record<string, any> {
  const unified: Record<string, any> = {};
  const nameMapping: Record<string, string> = {};
  
  // ูุฑุชุจโุณุงุฒ ูุงูโูุง ุจุฑุง ูพุฑุฏุงุฒุด ฺฉูพุงุฑฺู
  const allNames = Object.keys(staffStats);
  
  allNames.forEach(rawName => {
    const { normalizedName } = normalizeStaffName(rawName);
    
    if (!normalizedName) return;
    
    // ุจุฑุฑุณ ุดุจุงูุช ุจุง ูุงูโูุง ููุฌูุฏ
    let foundMatch = false;
    for (const [existingRaw, existingNormalized] of Object.entries(nameMapping)) {
      const { normalizedName: existingNorm } = normalizeStaffName(existingNormalized);
      
      // ุงฺฏุฑ ูุงู ูุฑูุงูโุดุฏู ฺฉ ุงุณุช ุง ฺฉ ุฒุฑูุฌููุนู ุฏฺฏุฑ ุงุณุช
      if (normalizedName === existingNorm || 
          normalizedName.includes(existingNorm) || 
          existingNorm.includes(normalizedName)) {
        // ุงุฒ ูุงู ุทููุงูโุชุฑ ุงุณุชูุงุฏู ฺฉู
        const betterName = normalizedName.length >= existingNorm.length ? normalizedName : existingNorm;
        nameMapping[rawName] = betterName;
        foundMatch = true;
        break;
      }
    }
    
    if (!foundMatch) {
      nameMapping[rawName] = normalizedName;
    }
  });
  
  // ุญุงูุง ุฏุงุฏูโูุง ุฑุง ฺฉูพุงุฑฺู ฺฉู
  allNames.forEach(rawName => {
    const targetName = nameMapping[rawName] || rawName;
    
    if (!unified[targetName]) {
      unified[targetName] = {
        presentDays: 0,
        absentDays: 0,
        totalOvertime: 0,
        totalReceived: 0,
        totalSpent: 0,
        dates: [],
        codes: new Set<string>(),
        rawNames: new Set<string>()
      };
    }
    
    const stats = staffStats[rawName];
    const { code } = normalizeStaffName(rawName);
    
    unified[targetName].presentDays += stats.presentDays || 0;
    unified[targetName].absentDays += stats.absentDays || 0;
    unified[targetName].totalOvertime += stats.totalOvertime || 0;
    unified[targetName].totalReceived += stats.totalReceived || 0;
    unified[targetName].totalSpent += stats.totalSpent || 0;
    if (stats.dates) unified[targetName].dates.push(...stats.dates);
    if (code) unified[targetName].codes.add(code);
    unified[targetName].rawNames.add(rawName);
  });
  
  return unified;
}

// ุชุงุจุน ุจุฑุง ฺฏุฑูุชู ุงุทูุงุนุงุช ฺฏุฒุงุฑุดุงุช ุฑูุฒุงูู
async function getDailyReportsContext(supabase: any): Promise<string> {
  try {
    const { data: recentReports, error } = await supabase
      .from("daily_reports")
      .select(`
        id, report_date, notes, created_at,
        daily_report_staff(staff_name, work_status, overtime_hours, amount_received, amount_spent, notes, spending_notes, receiving_notes, is_cash_box),
        daily_report_orders(order_id, team_name, activity_description, service_details, notes)
      `)
      .order("report_date", { ascending: false })
      .limit(60); // ฺฏุฒุงุฑุดุงุช 60 ุฑูุฒ ุงุฎุฑ ุจุฑุง ูุญุงุณุจู ุขูุงุฑ ุฏููโุชุฑ
    
    if (error || !recentReports || recentReports.length === 0) {
      return '\n๐ ฺฏุฒุงุฑุดุงุช ุฑูุฒุงูู: ูููุฒ ฺฏุฒุงุฑุด ุซุจุช ูุดุฏู ุงุณุช.';
    }

    let context = `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ฺฏุฒุงุฑุดุงุช ุฑูุฒุงูู (${recentReports.length} ฺฏุฒุงุฑุด ุงุฎุฑ)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ๏ธ ูฺฉุชู ููู: ูุงู ฺฉุงุฑฺฉูุงู ููฺฉู ุงุณุช ุจุง ฺฉุฏูุง ูุฎุชูู ุฏุฑ ฺฏุฒุงุฑุดุงุช ุขูุฏู ุจุงุดุฏ.
ุณุณุชู ุจู ุตูุฑุช ููุดููุฏ ูุงูโูุง ูุดุงุจู ุฑุง ฺฉูพุงุฑฺู ูโฺฉูุฏ.
`;

    recentReports.forEach((report: any) => {
      const reportDate = new Date(report.report_date).toLocaleDateString('fa-IR');
      const staffCount = report.daily_report_staff?.filter((s: any) => !s.is_cash_box)?.length || 0;
      const ordersCount = report.daily_report_orders?.length || 0;
      
      // ูุญุงุณุจู ูุฌููุน ุฏุฑุงูุช ู ูพุฑุฏุงุฎุช
      let totalReceived = 0;
      let totalSpent = 0;
      let totalOvertime = 0;
      let presentCount = 0;
      
      report.daily_report_staff?.forEach((staff: any) => {
        if (!staff.is_cash_box) {
          totalReceived += Number(staff.amount_received) || 0;
          totalSpent += Number(staff.amount_spent) || 0;
          totalOvertime += Number(staff.overtime_hours) || 0;
          if (staff.work_status === 'ุญุงุถุฑ' || staff.work_status === 'ฺฉุงุฑฺฉุฑุฏู') {
            presentCount++;
          }
        }
      });

      context += `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ฺฏุฒุงุฑุด ุชุงุฑุฎ: ${reportDate}
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ฅ ุชุนุฏุงุฏ ูุฑููุง: ${staffCount} ููุฑ (${presentCount} ุญุงุถุฑ)
โ ๐ฆ ุชุนุฏุงุฏ ุณูุงุฑุดุงุช: ${ordersCount} ุณูุงุฑุด
โ ๐ฐ ูุฌููุน ุฏุฑุงูุช: ${totalReceived.toLocaleString('fa-IR')} ุชููุงู
โ ๐ธ ูุฌููุน ูุฒููโูุง: ${totalSpent.toLocaleString('fa-IR')} ุชููุงู
โ โฑ๏ธ ูุฌููุน ุงุถุงููโฺฉุงุฑ: ${totalOvertime} ุณุงุนุช
โ ${report.notes ? `๐ ุงุฏุฏุงุดุช: ${report.notes}` : ''}
โ
โ ๐ท ูุณุช ูุฑููุง:`;

      // ููุงุด ุฌุฒุฆุงุช ูุฑ ูุฑู ุจุง ูุงู ูุฑูุงูโุดุฏู
      report.daily_report_staff?.filter((s: any) => !s.is_cash_box && s.staff_name).forEach((staff: any) => {
        const { normalizedName } = normalizeStaffName(staff.staff_name);
        const displayName = normalizedName || staff.staff_name;
        const workStatus = staff.work_status === 'ุญุงุถุฑ' || staff.work_status === 'ฺฉุงุฑฺฉุฑุฏู' ? 'โ ุญุงุถุฑ' : 'โ ุบุงุจ';
        const overtime = staff.overtime_hours > 0 ? ` | ุงุถุงููโฺฉุงุฑ: ${staff.overtime_hours} ุณุงุนุช` : '';
        const received = staff.amount_received > 0 ? ` | ุฏุฑุงูุช: ${Number(staff.amount_received).toLocaleString('fa-IR')}` : '';
        const spent = staff.amount_spent > 0 ? ` | ูุฒูู: ${Number(staff.amount_spent).toLocaleString('fa-IR')}` : '';
        context += `
โ   โข ${displayName}: ${workStatus}${overtime}${received}${spent}`;
      });

      context += `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
`;
    });

    // ูุญุงุณุจู ุขูุงุฑ ฺฉู ฺฉุงุฑฺฉุฑุฏ ูุฑ ูุฑู ุฏุฑ ฺฉู ฺฏุฒุงุฑุดุงุช - ุจุง ฺฉูพุงุฑฺูโุณุงุฒ ูุงูโูุง
    const staffStatsRaw: Record<string, { presentDays: number; absentDays: number; totalOvertime: number; totalReceived: number; totalSpent: number; dates: string[] }> = {};
    
    recentReports.forEach((report: any) => {
      const reportDate = report.report_date;
      report.daily_report_staff?.filter((s: any) => !s.is_cash_box && s.staff_name).forEach((staff: any) => {
        const rawName = staff.staff_name.trim();
        if (!staffStatsRaw[rawName]) {
          staffStatsRaw[rawName] = { presentDays: 0, absentDays: 0, totalOvertime: 0, totalReceived: 0, totalSpent: 0, dates: [] };
        }
        if (staff.work_status === 'ุญุงุถุฑ' || staff.work_status === 'ฺฉุงุฑฺฉุฑุฏู') {
          staffStatsRaw[rawName].presentDays++;
        } else {
          staffStatsRaw[rawName].absentDays++;
        }
        staffStatsRaw[rawName].totalOvertime += Number(staff.overtime_hours) || 0;
        staffStatsRaw[rawName].totalReceived += Number(staff.amount_received) || 0;
        staffStatsRaw[rawName].totalSpent += Number(staff.amount_spent) || 0;
        staffStatsRaw[rawName].dates.push(reportDate);
      });
    });

    // ฺฉูพุงุฑฺูโุณุงุฒ ูุงูโูุง ูุดุงุจู
    const staffStats = unifyStaffNames(staffStatsRaw);

    // ุงุถุงูู ฺฉุฑุฏู ุขูุงุฑ ฺฉู ุจู context
    if (Object.keys(staffStats).length > 0) {
      context += `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุขูุงุฑ ฺฉู ฺฉุงุฑฺฉุฑุฏ ูุฑููุง (${recentReports.length} ุฑูุฒ ฺฏุฐุดุชู)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ๏ธ ุชูุฌู: ุงฺฏุฑ ฺฉ ููุฑ ุจุง ฺฉุฏูุง ูุฎุชูู ุฏุฑ ฺฏุฒุงุฑุดุงุช ุซุจุช ุดุฏู ุจุงุดุฏุ
ุขูุงุฑ ุงู ุจู ุตูุฑุช ฺฉูพุงุฑฺู ูุญุงุณุจู ุดุฏู ุงุณุช.
`;
      Object.entries(staffStats)
        .sort((a: any, b: any) => b[1].presentDays - a[1].presentDays)
        .forEach(([name, stats]: [string, any]) => {
          const codesArr = Array.from(stats.codes || []) as string[];
          const codesInfo = codesArr.length > 0 ? ` (ฺฉุฏูุง: ${codesArr.join('ุ ')})` : '';
          context += `
โข ${name}${codesInfo}:
   โ ุฑูุฒูุง ฺฉุงุฑฺฉุฑุฏู: ${stats.presentDays} ุฑูุฒ
   โ ุฑูุฒูุง ุบุจุช: ${stats.absentDays} ุฑูุฒ
   โฑ๏ธ ูุฌููุน ุงุถุงููโฺฉุงุฑ: ${stats.totalOvertime} ุณุงุนุช
   ๐ฐ ูุฌููุน ุฏุฑุงูุช: ${stats.totalReceived.toLocaleString('fa-IR')} ุชููุงู
   ๐ธ ูุฌููุน ูุฒูู: ${stats.totalSpent.toLocaleString('fa-IR')} ุชููุงู
`;
        });
    }

    return context;
  } catch (error) {
    console.error('Error getting daily reports context:', error);
    return '';
  }
}

// ุชุงุจุน ุจุฑุง ฺฏุฑูุชู ูุณุช ูุฑููุง
async function getStaffListContext(supabase: any): Promise<string> {
  try {
    const { data: staffProfiles, error } = await supabase
      .from("internal_staff_profiles")
      .select(`
        id, user_id, status,
        organizational_positions(name),
        regions(name)
      `)
      .eq("status", "approved");
    
    if (error || !staffProfiles || staffProfiles.length === 0) {
      return '\n๐ฅ ูุฑููุง: ูฺ ูุฑู ุซุจุช ูุดุฏู ุงุณุช.';
    }

    // ฺฏุฑูุชู ูพุฑููุงูโูุง
    const userIds = staffProfiles.map((s: any) => s.user_id);
    const { data: profiles } = await supabase
      .from("profiles")
      .select("user_id, full_name, phone_number")
      .in("user_id", userIds);
    
    const profileMap = new Map(profiles?.map((p: any) => [p.user_id, p]) || []);

    let context = `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฅ ูุณุช ูุฑููุง (${staffProfiles.length} ููุฑ)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
`;

    // ฺฏุฑููโุจูุฏ ุจุฑ ุงุณุงุณ ุณูุช
    const byPosition: Record<string, any[]> = {};
    staffProfiles.forEach((staff: any) => {
      const positionName = staff.organizational_positions?.name || 'ุณุงุฑ';
      if (!byPosition[positionName]) byPosition[positionName] = [];
      const profile: any = profileMap.get(staff.user_id);
      byPosition[positionName].push({
        name: profile?.full_name || 'ูุงูุดุฎุต',
        phone: profile?.phone_number || '',
        region: staff.regions?.name || ''
      });
    });

    Object.entries(byPosition).forEach(([position, staffList]) => {
      context += `\n๐ท๏ธ ${position} (${staffList.length} ููุฑ):\n`;
      staffList.forEach((s: any) => {
        context += `   โข ${s.name}${s.region ? ` - ${s.region}` : ''}${s.phone ? ` - ${s.phone}` : ''}\n`;
      });
    });

    return context;
  } catch (error) {
    console.error('Error getting staff list context:', error);
    return '';
  }
}

// ุชุงุจุน ุจุฑุง ฺฏุฑูุชู ุณูุงุฑุดุงุช ุงุฎุฑ (ุจุฑุง ูุงฺูู ุงุฌุฑุง)
async function getRecentOrdersContext(supabase: any): Promise<string> {
  try {
    const { data: rawOrders, error } = await supabase
      .from("projects_v3")
      .select(`
        id, code, status, execution_stage, address,
        customer_name, customer_phone, total_price, total_paid,
        created_at, execution_start_date, execution_end_date,
        is_archived, is_deep_archived, archived_at, deep_archived_at,
        provinces:province_id (name),
        subcategories:subcategory_id (name)
      `)
      .order("created_at", { ascending: false })
      .limit(50);

    const orders = (rawOrders || [])
      .filter((o: any) => {
        const archived =
          o?.is_archived === true ||
          o?.is_deep_archived === true ||
          o?.archived_at != null ||
          o?.deep_archived_at != null;
        return !archived;
      })
      .slice(0, 15);

    
    if (error || !orders || orders.length === 0) {
      return '\n๐ฆ ุณูุงุฑุดุงุช: ูููุฒ ุณูุงุฑุด ุซุจุช ูุดุฏู ุงุณุช.';
    }

    const statusMap: Record<string, string> = {
      'pending': 'ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ',
      'approved': 'ุชุงุฏ ุดุฏู',
      'in_progress': 'ุฏุฑ ุญุงู ุงุฌุฑุง',
      'completed': 'ุชฺฉูู ุดุฏู',
      'awaiting_collection': 'ุฏุฑ ุงูุชุธุงุฑ ุฌูุนโุขูุฑ',
      'collected': 'ุฌูุนโุขูุฑ ุดุฏู',
      'closed': 'ุจุณุชู ุดุฏู',
      'rejected': 'ุฑุฏ ุดุฏู'
    };

    let context = `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฆ ุณูุงุฑุดุงุช ุงุฎุฑ (${orders.length} ุณูุงุฑุด)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
`;

    // ุขูุงุฑ ฺฉู
    let totalPrice = 0;
    let totalPaid = 0;
    const statusCounts: Record<string, number> = {};

    orders.forEach((order: any) => {
      totalPrice += Number(order.total_price) || 0;
      totalPaid += Number(order.total_paid) || 0;
      const status = order.status || 'pending';
      statusCounts[status] = (statusCounts[status] || 0) + 1;
    });

    context += `\n๐ ุฎูุงุตู:\n`;
    Object.entries(statusCounts).forEach(([status, count]) => {
      context += `   โข ${statusMap[status] || status}: ${count} ุณูุงุฑุด\n`;
    });
    context += `   ๐ฐ ูุฌููุน ูุจุงูุบ: ${totalPrice.toLocaleString('fa-IR')} ุชููุงู\n`;
    context += `   โ ูุฌููุน ูพุฑุฏุงุฎุช: ${totalPaid.toLocaleString('fa-IR')} ุชููุงู\n`;
    context += `   โณ ูุงูุฏู: ${(totalPrice - totalPaid).toLocaleString('fa-IR')} ุชููุงู\n`;

    context += `\n๐ ูุณุช ุณูุงุฑุดุงุช:\n`;
    orders.slice(0, 10).forEach((order: any) => {
      const statusFa = statusMap[order.status] || order.status;
      const date = new Date(order.created_at).toLocaleDateString('fa-IR');
      context += `   ๐ฆ ${order.code} | ${order.customer_name || 'ุจุฏูู ูุงู'} | ${statusFa} | ${order.provinces?.name || ''} | ${date}\n`;
    });

    return context;
  } catch (error) {
    console.error('Error getting recent orders context:', error);
    return '';
  }
}

// ุชุงุจุน ุจุฑุง ฺฏุฑูุชู ุงุทูุงุนุงุช ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ
async function getUserOrdersContext(supabase: any, userId: string): Promise<string> {
  try {
    // ุงูู customer_id ุฑุง ูพุฏุง ฺฉูู
    const { data: customer, error: customerError } = await supabase
      .from('customers')
      .select('id, customer_code')
      .eq('user_id', userId)
      .single();

    if (customerError || !customer) {
      console.log('No customer found for user:', userId);
      return '';
    }

    // ูพุฑููุงู ฺฉุงุฑุจุฑ ุฑุง ุจฺฏุฑู
    const { data: profile } = await supabase
      .from('profiles')
      .select('full_name, phone_number')
      .eq('user_id', userId)
      .single();

    // ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ ุฑุง ุจุง ุชูุงู ุฌุฒุฆุงุช ุจฺฏุฑู
    const { data: rawOrders, error: ordersError } = await supabase
      .from('projects_v3')
      .select(`
        id,
        code,
        address,
        detailed_address,
        status,
        execution_stage,
        payment_amount,
        total_paid,
        payment_method,
        payment_confirmed_at,
        transaction_reference,
        notes,
        created_at,
        approved_at,
        execution_start_date,
        execution_end_date,
        execution_confirmed_at,
        customer_completion_date,
        executive_completion_date,
        closed_at,
        is_archived,
        is_deep_archived,
        archived_at,
        deep_archived_at,
        is_renewal,
        original_order_id,
        customer_name,
        customer_phone,
        location_lat,
        location_lng,
        provinces:province_id (name),
        districts:district_id (name),
        subcategories:subcategory_id (
          name, 
          code,
          service_types_v3:service_type_id (name)
        )
      `)
      .eq('customer_id', customer.id)
      .order('created_at', { ascending: false });

    const orders = (rawOrders || []).filter((o: any) => {
      const archived =
        o?.is_archived === true ||
        o?.is_deep_archived === true ||
        o?.archived_at != null ||
        o?.deep_archived_at != null;

      const status = (o?.status || '').toLowerCase();
      const rejected = status === 'rejected' || status === 'cancelled';

      return !archived && !rejected;
    });


    if (ordersError) {
      console.error('Error fetching orders:', ordersError);
      return '';
    }

    // ุฏุฑุฎูุงุณุชโูุง ุฌูุนโุขูุฑ ุฑุง ุจฺฏุฑู
    const { data: collectionRequests } = await supabase
      .from('collection_requests')
      .select('id, order_id, status, requested_date, created_at')
      .eq('customer_id', customer.id);

    // ุชุจุฏู ูุถุนุชโูุง ุจู ูุงุฑุณ
    const statusMap: Record<string, string> = {
      'pending': 'ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ',
      'approved': 'ุชุงุฏ ุดุฏู',
      'in_progress': 'ุฏุฑ ุญุงู ุงุฌุฑุง',
      'completed': 'ุชฺฉูู ุดุฏู',
      'awaiting_collection': 'ุฏุฑ ุงูุชุธุงุฑ ุฌูุนโุขูุฑ',
      'collected': 'ุฌูุนโุขูุฑ ุดุฏู',
      'closed': 'ุจุณุชู ุดุฏู',
      'rejected': 'ุฑุฏ ุดุฏู',
      'cancelled': 'ูุบู ุดุฏู'
    };

    const executionStageMap: Record<string, string> = {
      'pending_approval': 'ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ',
      'approved': 'ุชุงุฏ ุดุฏู',
      'scheduled': 'ุฒูุงูโุจูุฏ ุดุฏู',
      'in_progress': 'ุฏุฑ ุญุงู ุงุฌุฑุง',
      'order_executed': 'ุงุฌุฑุง ุดุฏู',
      'awaiting_collection': 'ุฏุฑ ุงูุชุธุงุฑ ุฌูุนโุขูุฑ',
      'in_collection': 'ุฏุฑ ุญุงู ุฌูุนโุขูุฑ',
      'collected': 'ุฌูุนโุขูุฑ ุดุฏู',
      'awaiting_payment': 'ุฏุฑ ุงูุชุธุงุฑ ูพุฑุฏุงุฎุช',
      'completed': 'ุชฺฉูู ุดุฏู'
    };

    const paymentMethodMap: Record<string, string> = {
      'online': 'ูพุฑุฏุงุฎุช ุขููุงู',
      'cash': 'ูพุฑุฏุงุฎุช ููุฏ',
      'card': 'ฺฉุงุฑุช ุจู ฺฉุงุฑุช',
      'check': 'ฺฺฉ',
      'transfer': 'ุงูุชูุงู ุจุงูฺฉ'
    };

    if (!orders || orders.length === 0) {
      return `

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ค ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ูุงู: ${profile?.full_name || 'ูุงูุดุฎุต'}
- ุดูุงุฑู ุชูุงุณ: ${profile?.phone_number || 'ูุงูุดุฎุต'}
- ฺฉุฏ ูุดุชุฑ: ${customer.customer_code || 'ุชุนู ูุดุฏู'}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฆ ุงุทูุงุนุงุช ุณูุงุฑุดุงุช
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ุงู ฺฉุงุฑุจุฑ ูููุฒ ุณูุงุฑุด ุซุจุช ูฺฉุฑุฏู ุงุณุช.`;
    }

    // ูุญุงุณุจู ุขูุงุฑ ฺฉู ุฏูู
    let totalPaymentAmount = 0;
    let totalPaidAmount = 0;
    let pendingOrders = 0;
    let approvedOrders = 0;
    let inProgressOrders = 0;
    let completedOrders = 0;
    let awaitingCollectionOrders = 0;
    let closedOrders = 0;
    let rejectedOrders = 0;
    let renewalOrders = 0;

    // ฺฏุฑููโุจูุฏ ุจุฑ ุงุณุงุณ ุขุฏุฑุณ
    const ordersByAddress: Record<string, any[]> = {};
    // ฺฏุฑููโุจูุฏ ุจุฑ ุงุณุงุณ ููุน ุฎุฏูุงุช
    const ordersByService: Record<string, any[]> = {};
    // ฺฏุฑููโุจูุฏ ุจุฑ ุงุณุงุณ ุงุณุชุงู
    const ordersByProvince: Record<string, any[]> = {};

    orders.forEach((order: any) => {
      const paymentAmount = order.payment_amount ? Number(order.payment_amount) : 0;
      totalPaymentAmount += paymentAmount;
      
      // ูุจูุบ ูพุฑุฏุงุฎุช ูุงูุน ุงุฒ ููุฏ total_paid ุฎูุงูุฏู ุดูุฏ (ูู payment_confirmed_at)
      const paidAmount = order.total_paid ? Number(order.total_paid) : 0;
      totalPaidAmount += paidAmount;

      // ุดูุงุฑุด ูุถุนุชโูุง
      switch (order.status) {
        case 'pending': pendingOrders++; break;
        case 'approved': approvedOrders++; break;
        case 'in_progress': inProgressOrders++; break;
        case 'completed': completedOrders++; break;
        case 'awaiting_collection': awaitingCollectionOrders++; break;
        case 'closed': case 'collected': closedOrders++; break;
        case 'rejected': case 'cancelled': rejectedOrders++; break;
      }

      if (order.is_renewal) renewalOrders++;

      // ฺฏุฑููโุจูุฏ ุจุฑ ุงุณุงุณ ุขุฏุฑุณ
      const addressKey = `${order.provinces?.name || ''} - ${order.address || ''}`;
      if (!ordersByAddress[addressKey]) ordersByAddress[addressKey] = [];
      ordersByAddress[addressKey].push(order);

      // ฺฏุฑููโุจูุฏ ุจุฑ ุงุณุงุณ ููุน ุฎุฏูุงุช
      const serviceKey = order.subcategories?.service_types_v3?.name || order.subcategories?.name || 'ุณุงุฑ';
      if (!ordersByService[serviceKey]) ordersByService[serviceKey] = [];
      ordersByService[serviceKey].push(order);

      // ฺฏุฑููโุจูุฏ ุจุฑ ุงุณุงุณ ุงุณุชุงู
      const provinceKey = order.provinces?.name || 'ูุงูุดุฎุต';
      if (!ordersByProvince[provinceKey]) ordersByProvince[provinceKey] = [];
      ordersByProvince[provinceKey].push(order);
    });

    const remainingAmount = totalPaymentAmount - totalPaidAmount;

    // ุณุงุฎุช ูุชู ุงุทูุงุนุงุช ุณูุงุฑุดุงุช
    let ordersContext = `

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ค ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ูุงู: ${profile?.full_name || 'ูุงูุดุฎุต'}
- ุดูุงุฑู ุชูุงุณ: ${profile?.phone_number || 'ูุงูุดุฎุต'}
- ฺฉุฏ ูุดุชุฑ: ${customer.customer_code || 'ุชุนู ูุดุฏู'}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุขูุงุฑ ฺฉู ุณูุงุฑุดุงุช (${orders.length} ุณูุงุฑุด)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ฐ ูุถุนุช ูุงู:
- ูุฌููุน ฺฉู ูุจุงูุบ ุณูุงุฑุดุงุช: ${totalPaymentAmount.toLocaleString('fa-IR')} ุชููุงู
- ูุจูุบ ูพุฑุฏุงุฎุช ุดุฏู (ุชุงุฏ ุดุฏู): ${totalPaidAmount.toLocaleString('fa-IR')} ุชููุงู
- ูุงูุฏู ุจุฏู: ${remainingAmount.toLocaleString('fa-IR')} ุชููุงู
${remainingAmount === 0 && totalPaymentAmount > 0 ? 'โ ุชูุงู ูุจุงูุบ ุชุณูู ุดุฏู ุงุณุช' : remainingAmount > 0 ? 'โ๏ธ ูุจุงูุบ ุจุงูโูุงูุฏู ุงุณุช' : ''}

๐ ูุถุนุช ุณูุงุฑุดุงุช:
- ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ: ${pendingOrders} ุณูุงุฑุด
- ุชุงุฏ ุดุฏู: ${approvedOrders} ุณูุงุฑุด
- ุฏุฑ ุญุงู ุงุฌุฑุง: ${inProgressOrders} ุณูุงุฑุด
- ุชฺฉูู ุดุฏู: ${completedOrders} ุณูุงุฑุด
- ุฏุฑ ุงูุชุธุงุฑ ุฌูุนโุขูุฑ: ${awaitingCollectionOrders} ุณูุงุฑุด
- ุจุณุชู ุดุฏู/ุฌูุนโุขูุฑ ุดุฏู: ${closedOrders} ุณูุงุฑุด
${rejectedOrders > 0 ? `- ุฑุฏ ุดุฏู/ูุบู ุดุฏู: ${rejectedOrders} ุณูุงุฑุด` : ''}
${renewalOrders > 0 ? `- ุณูุงุฑุดุงุช ุชุฌุฏุฏ/ุชูุฏุฏ: ${renewalOrders} ุณูุงุฑุด` : ''}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุชูฺฉฺฉ ุจุฑ ุงุณุงุณ ุขุฏุฑุณ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ`;

    Object.entries(ordersByAddress).forEach(([address, addressOrders]) => {
      ordersContext += `\n๐ ${address}: ${addressOrders.length} ุณูุงุฑุด`;
    });

    ordersContext += `

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ง ุชูฺฉฺฉ ุจุฑ ุงุณุงุณ ููุน ุฎุฏูุงุช:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ`;

    Object.entries(ordersByService).forEach(([service, serviceOrders]) => {
      const serviceTotal = serviceOrders.reduce((sum: number, o: any) => sum + (Number(o.payment_amount) || 0), 0);
      ordersContext += `\n๐ ${service}: ${serviceOrders.length} ุณูุงุฑุด (ูุฌููุน: ${serviceTotal.toLocaleString('fa-IR')} ุชููุงู)`;
    });

    ordersContext += `

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุขุฎุฑู ุณูุงุฑุดุงุช:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
`;

    orders.slice(0, 5).forEach((order: any, index: number) => {
      const statusFa = statusMap[order.status] || order.status;
      const createdDate = new Date(order.created_at).toLocaleDateString('fa-IR');
      const paymentAmount = order.payment_amount ? Number(order.payment_amount) : 0;
      const isPaid = !!order.payment_confirmed_at;
      
      ordersContext += `
๐ฆ ${order.code} | ${statusFa} | ${paymentAmount > 0 ? paymentAmount.toLocaleString('fa-IR') + ' ุชููุงู' : 'ููุช ุชุนู ูุดุฏู'} | ${isPaid ? 'โ ูพุฑุฏุงุฎุช ุดุฏู' : 'โณ'}
`;
    });

    return ordersContext;
  } catch (error) {
    console.error('Error getting user orders context:', error);
    return '';
  }
}

// ุชุงุจุน ุจุฑุง ฺฏุฑูุชู ุงุทูุงุนุงุช ฺฉุงุฑฺฉุฑุฏ ู ุญุณุงุจฺฉุชุงุจ ุฎูุฏ ฺฉุงุฑุจุฑ
async function getUserWorkRecordsContext(supabase: any, userId: string): Promise<string> {
  try {
    // ฺฏุฑูุชู ูพุฑููุงู ฺฉุงุฑุจุฑ
    const { data: profile } = await supabase
      .from('profiles')
      .select('full_name, phone_number')
      .eq('user_id', userId)
      .single();

    if (!profile?.phone_number) {
      return '';
    }

    // ุจุฑุฑุณ ุงูฺฉู ฺฉุงุฑุจุฑ ุฏุฑ HR ุซุจุช ุดุฏู ุงุณุช ุง ูู
    const { data: hrEmpCheck } = await supabase
      .from('hr_employees')
      .select('id, full_name')
      .eq('user_id', userId)
      .maybeSingle();

    if (!hrEmpCheck) {
      return '';
    }

    // ฺฏุฑูุชู ุฑฺฉูุฑุฏูุง ฺฉุงุฑฺฉุฑุฏ ฺฉุงุฑุจุฑ
    const { data: workRecords, error: workError } = await supabase
      .from('daily_report_staff')
      .select('*, daily_reports(report_date)')
      .eq('staff_user_id', userId)
      .order('created_at', { ascending: false });

    if (workError || !workRecords || workRecords.length === 0) {
      return `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ฺฉุงุฑฺฉุฑุฏ ู ุญุณุงุจฺฉุชุงุจ ุดูุง
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ุดูุง ุฏุณุชุฑุณ ุจู ูุงฺูู ุญุณุงุจฺฉุชุงุจ ู ฺฉุงุฑฺฉุฑุฏ ูพุฑุณูู ุฑุง ุฏุงุฑุฏ.
ุงูุง ูุชุฃุณูุงูู ูููุฒ ุณุงุจูู ฺฉุงุฑฺฉุฑุฏ ุจุฑุง ุดูุง ุซุจุช ูุดุฏู ุงุณุช.
`;
    }

    // ฺฏุฑูุชู ุงุทูุงุนุงุช HR ฺฉุงุฑุจุฑ
    const { data: hrEmployee } = await supabase
      .from('hr_employees')
      .select('full_name, phone_number, department, position, hire_date, status')
      .eq('user_id', userId)
      .maybeSingle();

    // ฺฏุฑูุชู ุชูุธูุงุช ุญููู ฺฉุงุฑุจุฑ ุจุง ุฑูุดโูุง ูุฎุชูู
    let salarySetting: any = null;
    
    // ุฌุณุชุฌู ุจุง ุดูุงุฑู ุชููู ฺฉุงูู
    if (profile.phone_number) {
      const { data: setting1 } = await supabase
        .from('staff_salary_settings')
        .select('*')
        .eq('staff_code', profile.phone_number)
        .maybeSingle();
      if (setting1) salarySetting = setting1;
    }
    
    // ุฌุณุชุฌู ุจุฏูู ุตูุฑ ุงุจุชุฏุง
    if (!salarySetting && profile.phone_number) {
      const normalizedPhone = profile.phone_number.startsWith('0') 
        ? profile.phone_number.substring(1) 
        : profile.phone_number;
      const { data: setting2 } = await supabase
        .from('staff_salary_settings')
        .select('*')
        .eq('staff_code', normalizedPhone)
        .maybeSingle();
      if (setting2) salarySetting = setting2;
    }
    
    // ุฌุณุชุฌู ุจุง ูุงู ุงุฒ HR
    if (!salarySetting && hrEmployee?.full_name) {
      const { data: setting3 } = await supabase
        .from('staff_salary_settings')
        .select('*')
        .eq('staff_name', hrEmployee.full_name)
        .maybeSingle();
      if (setting3) salarySetting = setting3;
    }

    // ฺฏุฑูุชู ููุฌูุฏ ฺฉู ูพูู
    const { data: walletTransactions } = await supabase
      .from('wallet_transactions')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(10);

    // ูุญุงุณุจู ุขูุงุฑ
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalOvertime = 0;
    let totalReceived = 0;
    let totalSpent = 0;

    // ฺฏุฑููโุจูุฏ ุจุฑ ุงุณุงุณ ูุงู ุดูุณ
    const monthlyStats: Record<string, { present: number; absent: number; overtime: number; received: number; spent: number; dates: string[]; records: any[] }> = {};

    workRecords.forEach((record: any) => {
      if (record.work_status === 'ุญุงุถุฑ') totalPresent++;
      if (record.work_status === 'ุบุงุจ') totalAbsent++;
      totalOvertime += Number(record.overtime_hours) || 0;
      totalReceived += Number(record.amount_received) || 0;
      totalSpent += Number(record.amount_spent) || 0;

      // ุชุจุฏู ุชุงุฑุฎ ุจู ูุงู ุดูุณ
      const reportDate = record.daily_reports?.report_date;
      if (reportDate) {
        const date = new Date(reportDate);
        const persianDate = date.toLocaleDateString('fa-IR');
        const parts = persianDate.split('/');
        const monthKey = `${parts[0]}/${parts[1]}`; // ุณุงู/ูุงู
        
        if (!monthlyStats[monthKey]) {
          monthlyStats[monthKey] = { present: 0, absent: 0, overtime: 0, received: 0, spent: 0, dates: [], records: [] };
        }
        
        if (record.work_status === 'ุญุงุถุฑ') monthlyStats[monthKey].present++;
        if (record.work_status === 'ุบุงุจ') monthlyStats[monthKey].absent++;
        monthlyStats[monthKey].overtime += Number(record.overtime_hours) || 0;
        monthlyStats[monthKey].received += Number(record.amount_received) || 0;
        monthlyStats[monthKey].spent += Number(record.amount_spent) || 0;
        monthlyStats[monthKey].dates.push(persianDate);
        monthlyStats[monthKey].records.push({
          date: persianDate,
          status: record.work_status,
          overtime: record.overtime_hours || 0,
          received: record.amount_received || 0,
          spent: record.amount_spent || 0,
          receivingNotes: record.receiving_notes,
          spendingNotes: record.spending_notes,
          notes: record.notes
        });
      }
    });

    const balance = totalReceived - totalSpent;

    // ูุญุงุณุจู ฺฉุงุฑฺฉุฑุฏ ุญููู
    let salaryEarnings = 0;
    let overtimeEarnings = 0;
    let salaryInfo = '';

    if (salarySetting) {
      const dailySalary = Number(salarySetting.base_daily_salary);
      const overtimeFraction = Number(salarySetting.overtime_rate_fraction);
      const overtimeDenominator = overtimeFraction > 0 ? Math.round(1 / overtimeFraction) : 6;
      const hourlyOvertime = dailySalary / overtimeDenominator;

      salaryEarnings = totalPresent * dailySalary;
      overtimeEarnings = Math.round(totalOvertime * hourlyOvertime);

      salaryInfo = `
๐ฐ ฺฉุงุฑฺฉุฑุฏ ุญููู:
- ุญููู ุฑูุฒุงูู ุชุนูโุดุฏู: ${dailySalary.toLocaleString('fa-IR')} ุชููุงู
- ุถุฑุจ ุงุถุงููโฺฉุงุฑ: ฑ/${overtimeDenominator}
- ุญููู ุฑูุฒูุง ุญุถูุฑ (${totalPresent} ุฑูุฒ): ${salaryEarnings.toLocaleString('fa-IR')} ุชููุงู
- ุงุถุงููโฺฉุงุฑ (${totalOvertime} ุณุงุนุช): ${overtimeEarnings.toLocaleString('fa-IR')} ุชููุงู
- ุฌูุน ฺฉุงุฑฺฉุฑุฏ ุญููู: ${(salaryEarnings + overtimeEarnings).toLocaleString('fa-IR')} ุชููุงู
`;
    } else {
      salaryInfo = `
๐ฐ ฺฉุงุฑฺฉุฑุฏ ุญููู:
โ๏ธ ุชูุธูุงุช ุญููู ุจุฑุง ุดูุง ุซุจุช ูุดุฏู ุงุณุช. ุจุฑุง ูุญุงุณุจู ฺฉุงุฑฺฉุฑุฏุ ูุฏุฑ ุจุงุฏ ุชูุธูุงุช ุญููู ุดูุง ุฑุง ุซุจุช ฺฉูุฏ.
`;
    }

    // ุงุทูุงุนุงุช HR
    let hrInfo = '';
    if (hrEmployee) {
      hrInfo = `
๐ค ุงุทูุงุนุงุช ูพุฑุณูู:
- ูุงู ฺฉุงูู: ${hrEmployee.full_name}
- ุดูุงุฑู ุชูุงุณ: ${hrEmployee.phone_number || profile.phone_number}
${hrEmployee.department ? `- ุฏูพุงุฑุชูุงู: ${hrEmployee.department}` : ''}
${hrEmployee.position ? `- ุณูุช: ${hrEmployee.position}` : ''}
${hrEmployee.hire_date ? `- ุชุงุฑุฎ ุงุณุชุฎุฏุงู: ${new Date(hrEmployee.hire_date).toLocaleDateString('fa-IR')}` : ''}
- ูุถุนุช: ${hrEmployee.status === 'active' ? 'โ ูุนุงู' : 'โช ุบุฑูุนุงู'}
`;
    }

    // ุงุทูุงุนุงุช ฺฉู ูพูู
    let walletInfo = '';
    if (walletTransactions && walletTransactions.length > 0) {
      const latestBalance = walletTransactions[0]?.balance_after || 0;
      walletInfo = `
๐ผ ฺฉู ูพูู:
- ููุฌูุฏ ูุนู: ${Number(latestBalance).toLocaleString('fa-IR')} ุชููุงู
- ุขุฎุฑู ุชุฑุงฺฉูุดโูุง:`;
      walletTransactions.slice(0, 5).forEach((tx: any) => {
        const txDate = new Date(tx.created_at).toLocaleDateString('fa-IR');
        const txType = tx.transaction_type === 'income' ? '๐ฅ ุฏุฑุงูุช' : '๐ค ุจุฑุฏุงุดุช';
        walletInfo += `\n  ${txType}: ${Number(tx.amount).toLocaleString('fa-IR')} ุชููุงู (${txDate})${tx.title ? ` - ${tx.title}` : ''}`;
      });
    }

    // ูุญุงุณุจู ุญููู ูุงูุงูู ุฏูู
    let monthlySalaryDetails = '';
    const sortedMonths = Object.keys(monthlyStats).sort().reverse();
    
    if (salarySetting && sortedMonths.length > 0) {
      const dailySalary = Number(salarySetting.base_daily_salary);
      const overtimeFraction = Number(salarySetting.overtime_rate_fraction);
      const overtimeDenominator = overtimeFraction > 0 ? Math.round(1 / overtimeFraction) : 6;
      const hourlyOvertime = dailySalary / overtimeDenominator;

      monthlySalaryDetails = `

๐ ุฌุฒุฆุงุช ุญููู ูุงูุงูู:`;
      
      sortedMonths.slice(0, 6).forEach(month => {
        const stats = monthlyStats[month];
        const monthName = getJalaliMonthName(parseInt(month.split('/')[1]));
        const monthlySalary = stats.present * dailySalary;
        const monthlyOvertime = Math.round(stats.overtime * hourlyOvertime);
        const monthlyNet = monthlySalary + monthlyOvertime - stats.spent + stats.received;
        const monthlyBalance = stats.received - stats.spent;
        
        monthlySalaryDetails += `

๐๏ธ ${monthName} ${month.split('/')[0]}:
   โโ ฺฉุงุฑฺฉุฑุฏ: ${stats.present} ุฑูุฒ ุญุถูุฑ | ${stats.absent} ุฑูุฒ ุบุจุช | ${stats.overtime} ุณุงุนุช ุงุถุงููโฺฉุงุฑ
   โโ ุญููู ูพุงู: ${monthlySalary.toLocaleString('fa-IR')} ุชููุงู
   โโ ุงุถุงููโฺฉุงุฑ: ${monthlyOvertime.toLocaleString('fa-IR')} ุชููุงู
   โโ ุฏุฑุงูุช ููุฏ: ${stats.received.toLocaleString('fa-IR')} ุชููุงู
   โโ ูพุฑุฏุงุฎุช (ูุฒูู): ${stats.spent.toLocaleString('fa-IR')} ุชููุงู
   โโ ูุงูุฏู ูุงูุงูู: ${monthlyBalance >= 0 ? '+' : ''}${monthlyBalance.toLocaleString('fa-IR')} ุชููุงู`;
        
        // ููุงุด ุฌุฒุฆุงุช ุฑูุฒุงูู ุจุฑุง ูุงู ุฌุงุฑ
        if (sortedMonths.indexOf(month) === 0 && stats.records.length > 0) {
          monthlySalaryDetails += `
   
   ๐ ุฌุฒุฆุงุช ุฑูุฒุงูู ุงู ูุงู:`;
          stats.records.slice(0, 10).forEach((rec: any) => {
            const statusIcon = rec.status === 'ุญุงุถุฑ' ? 'โ' : rec.status === 'ุบุงุจ' ? 'โ' : 'โช';
            let dayDetails = `\n   ${rec.date}: ${statusIcon} ${rec.status}`;
            if (rec.overtime > 0) dayDetails += ` | โฐ ${rec.overtime}ุณ ุงุถุงููโฺฉุงุฑ`;
            if (rec.received > 0) dayDetails += ` | ๐ฅ ${Number(rec.received).toLocaleString('fa-IR')}`;
            if (rec.spent > 0) dayDetails += ` | ๐ค ${Number(rec.spent).toLocaleString('fa-IR')}`;
            if (rec.receivingNotes) dayDetails += ` (${rec.receivingNotes})`;
            if (rec.spendingNotes) dayDetails += ` (${rec.spendingNotes})`;
            monthlySalaryDetails += dayDetails;
          });
          if (stats.records.length > 10) {
            monthlySalaryDetails += `\n   ... ู ${stats.records.length - 10} ุฑฺฉูุฑุฏ ุฏฺฏุฑ`;
          }
        }
      });
    }

    let context = `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ฺฉุงุฑฺฉุฑุฏ ู ุญุณุงุจฺฉุชุงุจ ุดูุง (${profile.full_name || 'ฺฉุงุฑุจุฑ'})
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${hrInfo}
๐ ุขูุงุฑ ฺฉู:
- ุชุนุฏุงุฏ ฺฉู ุซุจุชโูุง: ${workRecords.length} ุฑฺฉูุฑุฏ
- ุฑูุฒูุง ุญุถูุฑ: ${totalPresent} ุฑูุฒ
- ุฑูุฒูุง ุบุจุช: ${totalAbsent} ุฑูุฒ
- ุณุงุนุงุช ุงุถุงููโฺฉุงุฑ: ${totalOvertime} ุณุงุนุช

๐ต ุฎูุงุตู ูุงู:
- ฺฉู ุฏุฑุงูุช (ููุฏ): ${totalReceived.toLocaleString('fa-IR')} ุชููุงู
- ฺฉู ูพุฑุฏุงุฎุช (ูุฒูู): ${totalSpent.toLocaleString('fa-IR')} ุชููุงู
- ูุงูุฏู ุญุณุงุจ: ${balance >= 0 ? '+' : ''}${balance.toLocaleString('fa-IR')} ุชููุงู (${balance >= 0 ? 'ุทูุจ ุงุฒ ุดุฑฺฉุช' : 'ุจุฏู ุจู ุดุฑฺฉุช'})

${salaryInfo}
${walletInfo}
${monthlySalaryDetails}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ก ุฑุงูููุง ุญุณุงุจฺฉุชุงุจ:
- "ูุงูุฏู ุญุณุงุจ" = ุฏุฑุงูุช - ูพุฑุฏุงุฎุช (ุงฺฏุฑ ูุซุจุช ุจุงุดุฏ ุนู ุดูุง ุทูุจฺฉุงุฑุฏ)
- "ฺฉุงุฑฺฉุฑุฏ ุญููู" = ุญููู ุฑูุฒุงูู ร ุฑูุฒูุง ุญุถูุฑ + ุงุถุงููโฺฉุงุฑ
- ูุฑ ุณุงุนุช ุงุถุงููโฺฉุงุฑ = ุญููู ุฑูุฒุงูู รท ุถุฑุจ ุงุถุงููโฺฉุงุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
`;

    return context;
  } catch (error) {
    console.error('Error getting user work records context:', error);
    return '';
  }
}

// ุชุงุจุน ฺฉูฺฉ ุจุฑุง ูุงู ูุงูโูุง ุดูุณ
function getJalaliMonthName(month: number): string {
  const months = ['', 'ูุฑูุฑุฏู', 'ุงุฑุฏุจูุดุช', 'ุฎุฑุฏุงุฏ', 'ุชุฑ', 'ูุฑุฏุงุฏ', 'ุดูุฑูุฑ', 'ููุฑ', 'ุขุจุงู', 'ุขุฐุฑ', 'ุฏ', 'ุจููู', 'ุงุณููุฏ'];
  return months[month] || '';
}

function isDebtQuestion(text: string): boolean {
  const t = (text || '').replace(/\s+/g, ' ').trim();
  if (!t) return false;

  // ูพูุดุด ุฑุงุฌโุชุฑู ุณูุงูุงุช ฺฉุงุฑุจุฑุงู ุฏุฑุจุงุฑู ูุงูุฏู/ุจุฏู
  return /(ฺูุฏุฑ.*(ุจุฏูฺฉุงุฑ|ุจุฏู|ูุงูุฏู|ูููุฏู))|((ูุงูุฏู|ูููุฏู).*(ุจุฏู|ุญุณุงุจ))|((ุจุฏู|ุจุฏูฺฉุงุฑ).*(ฺูุฏุฑ|ูุงูุฏู|ูููุฏู))|(ุญุณุงุจ.*(ูุงูุฏู|ูููุฏู|ุจุฏู|ุจุฏูฺฉุงุฑ))/i.test(t);
}

function buildSseTextStream(text: string): ReadableStream<Uint8Array> {
  const encoder = new TextEncoder();
  return new ReadableStream({
    start(controller) {
      controller.enqueue(
        encoder.encode(
          `data: ${JSON.stringify({ choices: [{ delta: { content: text } }] })}\n\n`
        )
      );
      controller.enqueue(encoder.encode('data: [DONE]\n\n'));
      controller.close();
    },
  });
}

async function computeActiveCustomerDebt(
  supabase: any,
  userId: string
): Promise<{ remaining: number; total: number; paid: number; ordersCount: number } | null> {
  const { data: customer, error: customerError } = await supabase
    .from('customers')
    .select('id')
    .eq('user_id', userId)
    .maybeSingle();

  if (customerError) {
    console.error('Debt calc customer error:', customerError);
    return null;
  }
  if (!customer?.id) return null;

  const { data: rawOrders, error: ordersError } = await supabase
    .from('projects_v3')
    .select('id, payment_amount, total_paid, notes, status, is_archived, is_deep_archived, archived_at, deep_archived_at')
    .eq('customer_id', customer.id)
    .order('created_at', { ascending: false })
    .limit(500);

  if (ordersError) {
    console.error('Debt calc orders error:', ordersError);
    return null;
  }

  const activeOrders = (rawOrders || []).filter((o: any) => {
    const archived =
      o?.is_archived === true ||
      o?.is_deep_archived === true ||
      o?.archived_at != null ||
      o?.deep_archived_at != null;

    const status = (o?.status || '').toLowerCase();
    const rejected = status === 'rejected' || status === 'cancelled';

    return !archived && !rejected;
  });

  const orderIds = activeOrders.map((o: any) => o.id).filter(Boolean);
  const paymentsByOrder: Record<string, number> = {};

  if (orderIds.length > 0) {
    const { data: payments, error: payErr } = await supabase
      .from('order_payments')
      .select('order_id, amount')
      .in('order_id', orderIds);

    if (payErr) {
      console.error('Debt calc payments error:', payErr);
    }

    (payments || []).forEach((p: any) => {
      const oid = p.order_id as string;
      paymentsByOrder[oid] = (paymentsByOrder[oid] || 0) + Number(p.amount || 0);
    });
  }

  let total = 0;
  let paid = 0;
  let remaining = 0;

  activeOrders.forEach((o: any) => {
    const totalAmount = Number(o.payment_amount || 0);
    if (!totalAmount || totalAmount <= 0) return;

    const paidField = Number(o.total_paid || 0);
    const cashPaid = Number(paymentsByOrder[o.id] || 0);

    let notesAdvance = 0;
    try {
      if (o.notes) {
        const notesObj = typeof o.notes === 'string' ? JSON.parse(o.notes) : o.notes;
        notesAdvance = Number(notesObj?.advance_payment || 0);
      }
    } catch {
      notesAdvance = 0;
    }

    const paidRaw = Math.max(paidField, cashPaid, notesAdvance);
    const paidCapped = Math.min(paidRaw, totalAmount);

    total += totalAmount;
    paid += paidCapped;
    remaining += Math.max(totalAmount - paidCapped, 0);
  });

  return { remaining, total, paid, ordersCount: activeOrders.length };
}

/**
 * ุชุดุฎุต ุณูุงูุงุช ูุฑุจูุท ุจู ุณูุงุฑุดุงุช ู ุญุณุงุจฺฉุชุงุจ
 * ุงู ุณูุงูุงุช ูุจุงุฏ ุงุฒ ุญุงูุธู ฺุช ุงุณุชูุงุฏู ฺฉููุฏ ฺูู ุฏุงุฏูโูุง ุฏุงุฆูุงู ุชุบุฑ ูโฺฉููุฏ
 */
function isOrderOrAccountingQuestion(text: string): boolean {
  const lower = text.toLowerCase().trim();
  const keywords = [
    'ุณูุงุฑุด', 'ุณูุงุฑุดุงุช', 'ุณูุงุฑุดุงุชู',
    'ุญุณุงุจ', 'ุญุณุงุจฺฉุชุงุจ', 'ุญุณุงุจู', 
    'ุจุฏู', 'ุจุฏูฺฉุงุฑ', 'ุทูุจฺฉุงุฑ', 'ูุงูุฏู', 'ุจุงูโูุงูุฏู',
    'ูพุฑุฏุงุฎุช', 'ูพุฑุฏุงุฎุช', 'ูพุฑุฏุงุฎุชู',
    'ูุฒูู', 'ูุจูุบ', 'ููุช', 'ูุงฺฉุชูุฑ',
    'ฺูุฏุฑ', 'ฺูุฏ ุชุง', 'ฺูุฏ ุณูุงุฑุด',
    'ฺฉุฏ ุณูุงุฑุด', 'ุดูุงุฑู ุณูุงุฑุด',
    'ูุถุนุช ุณูุงุฑุด', 'ูุฑุญูู ุณูุงุฑุด',
    'ุขุฏุฑุณ ุณูุงุฑุด', 'ููฺฉุดู ุณูุงุฑุด',
  ];
  return keywords.some(kw => lower.includes(kw));
}

serve(async (req) => {

  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { messages, userRole, imageBase64, userId } = await req.json();
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
    const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

    // ูพุงุณุฎ ูุทุน ุจุฑุง ุณูุงูุงุช ยซูุงูุฏู/ุจุฏูยป ุชุง ุฎุทุง ูุญุงุณุจู ุชูุณุท ูุฏู ุฑุฎ ูุฏูุฏ
    const lastUserText = Array.isArray(messages)
      ? (messages.slice().reverse().find((m: any) => m?.role === 'user')?.content ?? '')
      : '';

    if (
      userId &&
      SUPABASE_URL &&
      SUPABASE_SERVICE_ROLE_KEY &&
      typeof lastUserText === 'string' &&
      isDebtQuestion(lastUserText)
    ) {
      const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
      const debt = await computeActiveCustomerDebt(supabase, userId);

      const remaining = Math.round(debt?.remaining || 0);
      console.log('Debt quick-answer:', { userId, remaining, ordersCount: debt?.ordersCount || 0 });

      const answer = `ุงุฒ ุญุณุงุจ ุดูุง ุฏุฑ ุญุงู ุญุงุถุฑ ${remaining.toLocaleString('fa-IR')} ุชููุงู ูุงูุฏู ุจุฏู ูุฑุจูุท ุจู ุณูุงุฑุดุงุช ูุนุงู ุงุณุช.`;

      return new Response(buildSseTextStream(answer), {
        headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
      });
    }

    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    // ุงูุฒูุฏู ุงุทูุงุนุงุช ููุด ฺฉุงุฑุจุฑ ุจู ูพุฑุงููพุช ุณุณุชู
    let contextualPrompt = SYSTEM_PROMPT;
    
    // ุงฺฏุฑ ฺฉุงุฑุจุฑ ูุงฺฏู ฺฉุฑุฏูุ ุงุทูุงุนุงุช ูุงฺููโูุง ู ุณูุงุฑุดุงุชุด ุฑุง ุจฺฏุฑ
    if (userId && SUPABASE_URL && SUPABASE_SERVICE_ROLE_KEY) {
      const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
      
      // ฺฏุฑูุชู ูุงฺููโูุง ฺฉุงุฑุจุฑ
      const { moduleKeys, moduleNames } = await getUserModules(supabase, userId);
      const userRoles = await getUserRoles(supabase, userId);
      
      console.log('User modules:', moduleKeys);
      console.log('User roles:', userRoles);
      
      // ุงุทูุงุนุงุช ุณูุงุฑุดุงุช ฺฉุงุฑุจุฑ (ููุดู)
      const ordersContext = await getUserOrdersContext(supabase, userId);
      contextualPrompt += ordersContext;
      
      // ุงุทูุงุนุงุช ฺฉุงุฑฺฉุฑุฏ ู ุญุณุงุจฺฉุชุงุจ ุดุฎุต ฺฉุงุฑุจุฑ (ููุดู ุจุฑุง ฺฉุงุฑุจุฑุงู ฺฉู HR ูุณุชูุฏ)
      const workRecordsContext = await getUserWorkRecordsContext(supabase, userId);
      if (workRecordsContext) {
        contextualPrompt += workRecordsContext;
      }
      
      // ุจุฑุฑุณ ุฏุณุชุฑุณ ุจู ูุงฺููโูุง
      if (moduleKeys.length > 0) {
        const accessibleTopics = moduleKeys.flatMap(
          moduleKey => MODULE_CAPABILITIES[moduleKey]?.dataAccess || []
        );
        
        contextualPrompt += `

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูุงฺููโูุง ูุนุงู ุจุฑุง ุงู ฺฉุงุฑุจุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${moduleNames.map((name, i) => `${i + 1}. ${name}`).join("\n")}

ููุถูุนุงุช ฺฉู ูโุชูุงู ุฏุฑุจุงุฑู ุขูโูุง ุงุทูุงุนุงุช ุจุฏู:
${accessibleTopics.map(topic => `โข ${topic}`).join("\n")}

โ๏ธ ููู: ููุท ุฏุฑุจุงุฑู ููุถูุนุงุช ุจุงูุง ุงุทูุงุนุงุช ุชุฎุตุต ุจุฏู. ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฏุฑุจุงุฑู ููุถูุน ุณูุงู ฺฉุฑุฏ ฺฉู ูุงฺูู ุขู ุฑุง ูุฏุงุฑุฏุ ุจฺฏู:
"ูุชุฃุณูุงูู ุดูุง ุฏุณุชุฑุณ ุจู ุงู ุจุฎุด ุฑุง ูุฏุงุฑุฏ. ูุทูุงู ุงุฒ ูุฏุฑ ุจุฎูุงูุฏ ูุงฺูู ูุฑุจูุทู ุฑุง ุจุฑุง ุดูุง ูุนุงู ฺฉูุฏ."
`;

        // ุงุถุงูู ฺฉุฑุฏู ุงุทูุงุนุงุช ุจุฑ ุงุณุงุณ ูุงฺููโูุง
        if (moduleKeys.includes('daily_report')) {
          const reportsContext = await getDailyReportsContext(supabase);
          contextualPrompt += reportsContext;
        }
        
        if (moduleKeys.includes('staff_management') || moduleKeys.includes('daily_report')) {
          const staffContext = await getStaffListContext(supabase);
          contextualPrompt += staffContext;
        }
        
        if (moduleKeys.includes('scaffold_execution_with_materials') || moduleKeys.includes('ceo_dashboard')) {
          const ordersListContext = await getRecentOrdersContext(supabase);
          contextualPrompt += ordersListContext;
        }
      } else {
        contextualPrompt += `

โ๏ธ ุงู ฺฉุงุฑุจุฑ ูฺ ูุงฺูู ุชุฎุตุต ูุนุงู ูุฏุงุฑุฏ.
ููุท ุจู ุณูุงูุงุช ุนููู ุฏุฑุจุงุฑู ุณุงุช ู ุณูุงุฑุดุงุช ุดุฎุต ุงู ฺฉุงุฑุจุฑ ูพุงุณุฎ ุจุฏู.
ุงฺฏุฑ ุฏุฑุจุงุฑู ฺฏุฒุงุฑุดุงุช ุฑูุฒุงููุ ูุฑููุงุ ุง ุงุทูุงุนุงุช ูุฏุฑุช ุณูุงู ฺฉุฑุฏุ ุจฺฏู ฺฉู ุจุงุฏ ุงุฒ ูุฏุฑ ุจุฎูุงูุฏ ูุงฺูู ูุฑุจูุทู ุฑุง ุจุฑุงุด ูุนุงู ฺฉูุฏ.
`;
      }
      
      if (userRoles.length > 0) {
        contextualPrompt += `\n\nููุดโูุง ฺฉุงุฑุจุฑ: ${userRoles.join('ุ ')}`;
      }
    }

    // ุณุงุฎุช ูพุงูโูุง ุจุง ูพุดุชุจุงู ุงุฒ ุชุตูุฑ
    // ูฺฉุชู ููู: ุจุฑุง ุณูุงูุงุช ยซุณูุงุฑุดุงุช/ุญุณุงุจฺฉุชุงุจยปุ ุชุงุฑุฎฺู ฺุช ุฑุง ูุงุฏุฏู ูโฺฏุฑู
    // ุชุง ูุฏู ุชุญุช ุชุงุซุฑ ูพุงุณุฎโูุง ูุฏู ูุฑุงุฑ ูฺฏุฑุฏ (ฺูู ุฏุงุฏูโูุง ุฏุงุฆูุงู ุชุบุฑ ูโฺฉููุฏ).
    const shouldIgnoreChatHistory =
      !!userId && typeof lastUserText === 'string' && isOrderOrAccountingQuestion(lastUserText);

    if (shouldIgnoreChatHistory) {
      console.log('Ignoring chat history for order/accounting question');
    }

    const baseMessages = shouldIgnoreChatHistory
      ? [{ role: 'user', content: lastUserText }]
      : (Array.isArray(messages) ? messages : []);

    const formattedMessages = baseMessages.map((msg: { role: string; content: string }, index: number) => {
      // ุงฺฏุฑ ุชุตูุฑ ุฏุงุฑู ู ุงู ุขุฎุฑู ูพุงู ฺฉุงุฑุจุฑ ุงุณุช
      if (imageBase64 && msg.role === 'user' && index === baseMessages.length - 1) {
        return {
          role: msg.role,
          content: [
            {
              type: 'text',
              text:
                msg.content +
                "\n\nุชูุถุญ ููู: ฺฉุงุฑุจุฑ ฺฉ ุชุตูุฑ ุงุฒ ุณุงุช ุงูุฑู ูุฑุณุชุงุฏู ุงุณุช. ุงฺฏุฑ ุชุตูุฑ ูุฑุจูุท ุจู ฺฉุฑู ุฒูู ุทูุง ุงุณุชุ ุชูุถุญ ุจุฏู ฺฉู ุงู ฺฉุฑู ููุงุฏ ฺฏุณุชุฑุฏฺฏ ุฎุฏูุงุช ุงูุฑู ุฏุฑ ุณุฑุงุณุฑ ุงุฑุงู ุงุณุช ู ูุดุงูโุฏููุฏู ฺฉูุช ุทูุง ุฎุฏูุงุช ูุงุณุช. ุงฺฏุฑ ุชุตูุฑ ูุฑุจูุท ุจู ุจุฎุด ุฏฺฏุฑ ุงุฒ ุณุงุช ุงุณุชุ ุขู ุฑุง ุชูุถุญ ุจุฏู. ุงฺฏุฑ ุชุตูุฑ ุงุตูุงู ูุฑุจูุท ุจู ุณุงุช ูุณุชุ ููุฏุจุงูู ุจฺฏู ฺฉู ููุท ุฏุฑุจุงุฑู ุฎุฏูุงุช ุงูุฑู ูโุชูุงู ฺฉูฺฉ ฺฉู.",
            },
            {
              type: 'image_url',
              image_url: {
                url: `data:image/jpeg;base64,${imageBase64}`,
              },
            },
          ],
        };
      }
      return { role: msg.role, content: msg.content };
    });

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-flash",
        messages: [
          { role: "system", content: contextualPrompt },
          ...formattedMessages,
        ],
        stream: true,
      }),
    });

    if (!response.ok) {
      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "ุณุฑูุณ ูพุฑูุดุบูู ุงุณุช. ูุทูุงู ฺูุฏ ูุญุธู ุตุจุฑ ฺฉูุฏ." }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (response.status === 402) {
        return new Response(JSON.stringify({ error: "ุณุฑูุณ ูููุชุงู ุฏุฑ ุฏุณุชุฑุณ ูุณุช." }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      return new Response(JSON.stringify({ error: "ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด ุฏุฑุฎูุงุณุช" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (error) {
    console.error("Assistant chat error:", error);
    return new Response(JSON.stringify({ error: error instanceof Error ? error.message : "ุฎุทุง ูุงุดูุงุฎุชู" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});